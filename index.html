<!DOCTYPE html>
<html lang="it">
<head>
  <!-- Charset DEVE essere primo -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- Theme color per mobile browsers -->
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-TileColor" content="#000000">
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- SEO -->
  <title>Webcam Montefalcone di Val Fortore</title>
  <meta name="description" content="Webcam in diretta dal Comune di Montefalcone. Vista panoramica e condizioni meteo attuali">
  <meta name="keywords" content="webcam montefalcone, meteo montefalcone, comune di montefalcone live, telecamera diretta">
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="DLjKDn5UupGNdRgZXo9CuMc0Sg1S1aULxDJfIHT9tYo">
  <link rel="canonical" href="https://www.webcammontefalconedivalfortore.it/">
  
  <!-- Open Graph completo -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.webcammontefalconedivalfortore.it/">
  <meta property="og:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta property="og:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta property="og:image" content="https://www.webcammontefalconedivalfortore.it/p.png">
  <meta property="og:locale" content="it_IT">
  <meta property="og:site_name" content="Webcam Montefalcone">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta name="twitter:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta name="twitter:image" content="https://www.webcammontefalconedivalfortore.it/p.png">

  <!-- Preconnect per performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://live.webcammontefalconedivalfortore.it" crossorigin>
  
  <!-- DNS prefetch per risorse secondarie -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">

  <!-- Scripts -->
  <!-- Player: implementazione semplificata (video nativo + Hls.js solo quando serve) -->
<style>
    /* =====================================================
       CSS VARIABLES - Centralizzate per manutenibilità
       ===================================================== */
    :root {
      /* Blur */
      --blur-ui: 12px;
      --blur-play: 5px;
      
      /* Colors */
      --color-bg: #000;
      --color-live: #ff2b2b;
      --color-white: #fff;
      --color-overlay: rgba(0, 0, 0, 0.35);
      --color-border: rgba(255, 255, 255, 0.18);
      
      /* Radius */
      --radius-pill: 999px;
      --radius-video: 15px;
      
      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-medium: 260ms ease;
      --transition-slow: 500ms ease;
      
      /* Shadows */
      --shadow-glow: 0 0 30px rgba(255, 220, 150, 0.2);
      --shadow-deep: 0 40px 80px rgba(0, 0, 0, 0.95);
      --shadow-button: 0 10px 28px rgba(0, 0, 0, 0.28);
    }

    /* =====================================================
       RESET & BASE
       ===================================================== */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      overscroll-behavior: none;
      background-color: var(--color-bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* =====================================================
       FONTS
       ===================================================== */
    @font-face {
      font-family: 'MerryChristmasFont';
      src: url('last.otf') format('opentype');
      font-display: swap;
    }

    /* =====================================================
       LAYOUT PRINCIPALE
       ===================================================== */
    #main-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 20;
      transition: all var(--transition-slow);
    }

    @media (min-width: 1024px) {
      #main-container {
        transform: scale(0.965);
        transform-origin: center top;
      }
    }

    /* =====================================================
       BACKGROUND ANIMATO
       ===================================================== */
    #bg-static {
      position: absolute;
      top: -10%;
      left: -10%;
      width: 120%;
      height: 120%;
      background-image: url("1a.webp");
      background-size: cover;
      background-position: center;
      z-index: 0;
      filter: brightness(0.65) contrast(1.15) saturate(1.1);
      animation: driftingWorld 80s ease-in-out infinite alternate;
      pointer-events: none;
      will-change: transform;
    }

    @keyframes driftingWorld {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-2%, 2%) scale(1.05); }
    }

    /* =====================================================
       ELEMENTI DECORATIVI
       ===================================================== */
    .municipality-logo,
    .festive-message,
    .warm-flicker,
    .vignette,
    .particles-container {
      transition: opacity var(--transition-slow);
      opacity: 1;
      pointer-events: none;
    }

    .municipality-logo {
      width: 110px;
      height: auto;
      margin-bottom: 15px;
      z-index: 30;
      filter: brightness(1.1) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
    }

    .festive-message {
      font-family: 'MerryChristmasFont', 'Brush Script MT', cursive, serif;
      color: var(--color-white);
      text-align: center;
      font-size: 3.5rem;
      line-height: 1.2;
      margin-bottom: 25px;
      text-shadow: 2px 2px 4px var(--color-bg), 0 0 25px rgba(255, 255, 255, 0.6);
      z-index: 30;
      padding: 0 20px;
      width: 100%;
    }

    .warm-flicker {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 180, 50, 0.15), transparent 80%);
      z-index: 2;
      pointer-events: none;
      mix-blend-mode: overlay;
      animation: firePulse 4s ease-in-out infinite alternate;
    }

    @keyframes firePulse {
      0% { opacity: 0.1; }
      100% { opacity: 0.5; }
    }

    .vignette {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.7) 85%, var(--color-bg) 100%);
      z-index: 6;
      pointer-events: none;
    }

    /* =====================================================
       PARTICELLE (neve + embers)
       ===================================================== */
    .particles-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      overflow: hidden;
    }

    .snowflake {
      position: absolute;
      top: -10px;
      background: white;
      border-radius: 50%;
      opacity: 0.9;
      box-shadow: 0 0 3px white;
      will-change: transform;
    }

    .ember {
      position: absolute;
      bottom: -20px;
      background: #ffcc00;
      border-radius: 50%;
      opacity: 0;
      filter: blur(2px);
      will-change: transform, opacity;
    }

    @keyframes fall {
      0% { transform: translate(0, -10vh); }
      100% { transform: translate(15vw, 110vh); }
    }

    @keyframes riseRight {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      20% { opacity: 0.8; }
      100% { transform: translateY(-90vh) translateX(15vw); opacity: 0; }
    }

    @keyframes riseLeft {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      20% { opacity: 0.8; }
      100% { transform: translateY(-90vh) translateX(-15vw); opacity: 0; }
    }

    @keyframes riseZigZag {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      25% { transform: translateY(-20vh) translateX(5vw); opacity: 0.8; }
      75% { transform: translateY(-60vh) translateX(-5vw); opacity: 0.4; }
      100% { transform: translateY(-90vh) translateX(0); opacity: 0; }
    }

    /* =====================================================
       VIDEO WRAPPER
       ===================================================== */
    .video-wrapper {
      position: relative;
      width: auto;
      height: 60%;
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-video);
      overflow: hidden;
      background: var(--color-bg);
      box-shadow: var(--shadow-glow), var(--shadow-deep);
      border: 1px solid var(--color-border);
      z-index: 30;
      pointer-events: auto;
      transition: all 0.3s ease-out;
    }

    .video-wrapper:fullscreen,
    .video-wrapper:-webkit-full-screen,
    .video-wrapper:-moz-full-screen {
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      width: 100% !important;
      height: 100% !important;
    }
/* In fullscreen, assicurati che il <video> riempia il wrapper */
    #videoWrapper:fullscreen video,
    #videoWrapper:-webkit-full-screen video,
    #videoWrapper:-moz-full-screen video {
      width: 100% !important;
      height: 100% !important;
    }
/* =====================================================
       VIDEO ELEMENT (nuova implementazione)
       ===================================================== */
    #videoWrapper video {
      width: 100%;
      height: 100%;
      display: block;
      background: var(--color-bg);
      object-fit: contain;
    }
#videoWrapper .tap-layer {
      position: absolute;
      inset: 0;
      z-index: 10;
      cursor: default;
    }

    /* =====================================================
       BLUR PRIMERS - Elementi sempre visibili per mantenere
       il blur "caldo" su mobile. Sono trasparenti ma opacity:1
       ===================================================== */
    .blur-primer {
      position: absolute;
      width: 1px;
      height: 1px;
      opacity: 1;
      pointer-events: none;
      z-index: 1;
    }

    .blur-primer-play {
      top: 50%;
      left: 50%;
      backdrop-filter: blur(var(--blur-play)) brightness(1.05) saturate(1.1);
      -webkit-backdrop-filter: blur(var(--blur-play)) brightness(1.05) saturate(1.1);
    }

    .blur-primer-ui {
      bottom: 12px;
      right: 12px;
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
    }

    /* =====================================================
       LOADING OVERLAY
       ===================================================== */
    #videoWrapper .loading-overlay {
      position: absolute;
      inset: 0;
      z-index: 80;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-bg);
      opacity: 1;
      transition: opacity var(--transition-medium), visibility 0ms linear 0ms;
      pointer-events: none;
      visibility: visible;
    }

    #videoWrapper.is-ready .loading-overlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-medium), visibility 0ms linear var(--transition-medium);
    }

    #videoWrapper .loading-overlay .preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: blur(20px) brightness(0.5) saturate(0.8);
      transform: scale(1.1);
      opacity: 1;
    }

    #videoWrapper .loading-overlay .spinner {
      position: relative;
      width: 46px;
      height: 46px;
      border-radius: var(--radius-pill);
      border: 3px solid rgba(255, 255, 255, 0.25);
      border-top-color: rgba(255, 255, 255, 0.92);
      animation: spin 0.9s linear infinite;
      box-shadow: var(--shadow-button);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* =====================================================
       CONTROL BAR
       ===================================================== */
/* =====================================================
       CONTROL BAR (nuova implementazione)
       ===================================================== */
    #videoWrapper .control-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.75), transparent);
      pointer-events: none;
    }

    #videoWrapper.controls-visible .control-bar {
      pointer-events: auto;
    }
/* =====================================================
       FULLSCREEN BUTTON
       opacity minima 0.05 per forzare blur sempre attivo
       ===================================================== */
/* =====================================================
       FULLSCREEN BUTTON (nuova implementazione)
       ===================================================== */
    #videoWrapper .fs-btn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.20);
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      cursor: pointer;
      opacity: 0.05;
      transition: opacity var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      appearance: none;
      -webkit-appearance: none;
    }

    #videoWrapper .fs-btn svg {
      width: 20px;
      height: 20px;
      fill: var(--color-white);
      opacity: 0.92;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
    }

    #videoWrapper.controls-visible .fs-btn {
      opacity: 1;
    }
/* =====================================================
       LIVE BADGE
       ===================================================== */
    #videoWrapper .live-badge {
      position: absolute;
      left: 14px;
      bottom: 14px;
      z-index: 31;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-pill);
      color: var(--color-white);
      font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-weight: 700;
      font-size: 12px;
      line-height: 1;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.18);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-button);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      pointer-events: none;
    }

    #videoWrapper .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-live);
      box-shadow: 0 0 12px rgba(255, 43, 43, 0.95);
      animation: livePulse 1.6s infinite;
    }

    @keyframes livePulse {
      0% { opacity: 1; }
      50% { opacity: 0.45; }
      100% { opacity: 1; }
    }

    /* =====================================================
       OSD PLAY/PAUSE
       Migliorato con effetto glass più luminoso
       ===================================================== */
    #videoWrapper .osd {
      position: absolute;
      inset: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    #videoWrapper .osd-chip {
      position: relative;
      width: 84px;
      height: 84px;
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      padding: 0;
      margin: 0;
      font: inherit;
      color: inherit;
      
      /* Glass effect bilanciato */
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.22);
      backdrop-filter: blur(var(--blur-play)) brightness(1.05) saturate(1.1);
      -webkit-backdrop-filter: blur(var(--blur-play)) brightness(1.05) saturate(1.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      
      /* opacity minima 0.05 per forzare blur sempre attivo */
      opacity: 0.05;
      transform: scale(0.98);
      transition: opacity 140ms ease, transform 140ms ease;
    }

    #videoWrapper.controls-visible .osd-chip {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    #videoWrapper .osd-icon {
      width: 40px;
      height: 40px;
      fill: var(--color-white);
      opacity: 0.95;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    #videoWrapper .osd-icon.play {
      display: none;
    }

    #videoWrapper.is-paused .osd-icon.play {
      display: block;
    }

    #videoWrapper.is-paused .osd-icon.pause {
      display: none;
    }

    /* =====================================================
       CURTAINS (transizioni fullscreen)
       ===================================================== */
    #pageCurtain,
    #fsCurtain {
      background: var(--color-bg);
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
      will-change: opacity;
    }

    #pageCurtain {
      position: fixed;
      inset: 0;
      z-index: 9999;
    }

    #fsCurtain {
      position: absolute;
      inset: 0;
      z-index: 200;
      border-radius: inherit;
    }

    #pageCurtain.on,
    #fsCurtain.on {
      opacity: 1;
    }

    /* =====================================================
       RESPONSIVE - Mobile Portrait
       ===================================================== */
    @media (max-width: 768px) and (orientation: portrait) {
      #main-container {
        justify-content: flex-start;
        padding-top: 18vh;
      }

      .municipality-logo {
        width: 75px;
        margin-bottom: 10px;
      }

      .festive-message {
        font-size: 6vw;
        line-height: 1.4;
        margin-bottom: 20px;
      }

      .video-wrapper {
        width: 95%;
        height: auto;
      }

      #bg-static {
        animation: driftingWorldMobile 35s ease-in-out infinite alternate;
      }

      /* Tasti più piccoli su mobile */
      #videoWrapper .osd-chip {
        width: 68px;
        height: 68px;
      }

      #videoWrapper .osd-icon {
        width: 32px;
        height: 32px;
      }
#videoWrapper .fs-btn {
        width: 38px;
        height: 38px;
      }

      #videoWrapper .fs-btn svg {
        width: 18px;
        height: 18px;
      }
#videoWrapper .live-badge {
        padding: 6px 10px;
        font-size: 10px;
        gap: 6px;
      }

      #videoWrapper .live-dot {
        width: 6px;
        height: 6px;
      }
    }

    @keyframes driftingWorldMobile {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-3%, 0) scale(1.15); }
    }

    /* =====================================================
       RESPONSIVE - Landscape compatto
       ===================================================== */
    @media screen and (orientation: landscape) and (max-height: 600px) {
      .municipality-logo,
      .festive-message,
      #bg-static,
      .warm-flicker,
      .vignette,
      .particles-container {
        display: none !important;
      }

      #main-container {
        padding: 0 !important;
        justify-content: center !important;
        background: var(--color-bg);
      }

      .video-wrapper {
        width: 100vw;
        height: 100vh;
        border: none;
        border-radius: 0;
      }
    }

    /* =====================================================
       ACCESSIBILITÀ - Reduced Motion
       ===================================================== */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }

      .particles-container {
        display: none !important;
      }

      /* Mantieni solo lo spinner */
      #videoWrapper .loading-overlay .spinner {
        animation: spin 0.9s linear infinite !important;
      }
    }
  </style>
</head>

<body>
  <div id="bg-static"></div>
  <div class="warm-flicker"></div>
  <div class="vignette"></div>
  <div class="particles-container" id="particlesContainer"></div>

  <div id="main-container">
    <img 
      src="stemma2-removebg-preview.png" 
      alt="Stemma Comune di Montefalcone di Val Fortore" 
      class="municipality-logo"
      width="110"
      height="110"
      loading="eager"
    >

    <div class="festive-message">
      Il comune di Montefalcone di Val Fortore<br>
      augura a tutti Buone Feste
    </div>

    <div class="video-wrapper" id="videoWrapper">
      <!-- Blur primers: elementi invisibili ma opacity:1 per tenere il blur sempre attivo -->
      <div class="blur-primer blur-primer-play" aria-hidden="true"></div>
      <div class="blur-primer blur-primer-ui" aria-hidden="true"></div>

      <!-- Player: <video> nativo (iOS/Safari usa HLS nativo; altri browser usano Hls.js) -->
      <video
        id="liveVideo"
        autoplay
        muted
        playsinline
        webkit-playsinline
        preload="auto"
        crossorigin="anonymous"
        poster="https://www.webcammontefalconedivalfortore.it/p.png"
      ></video>

      <div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
        <img
          class="preview"
          src="https://www.webcammontefalconedivalfortore.it/p.png"
          alt=""
          loading="eager"
        >
        <div class="spinner" role="status" aria-label="Caricamento video in corso"></div>
      </div>

      <div class="tap-layer" id="tapLayer" aria-hidden="true"></div>

      <div class="live-badge" aria-hidden="true">
        <span class="live-dot"></span>
        <span>LIVE</span>
      </div>

      <div class="osd" aria-hidden="true">
        <button class="osd-chip" id="osdBtn" type="button" aria-label="Play/Pausa">
          <svg class="osd-icon play" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg class="osd-icon pause" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
      </div>

      <div class="control-bar" aria-hidden="true">
        <button class="fs-btn" id="fsBtn" type="button" aria-label="Schermo intero">
          <!-- Icona fullscreen (stile simile ai player standard) -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H5v5zm10 9h-3v2h5v-5h-2v3zm0-14V5h-5v2h3v3h2z"/>
          </svg>
        </button>
      </div>

      <div id="fsCurtain" aria-hidden="true"></div>
    </div>
  </div>

  <div id="pageCurtain" aria-hidden="true"></div>

  <script type="module">
    (() => {
      'use strict';

      /* =====================================================
         CONFIG
         ===================================================== */
      const STREAM_URL = "https://live.webcammontefalconedivalfortore.it/memfs/58e0bcbe-f1bd-4c8b-85f7-b4566a3e5392.m3u8";
      const HLS_JS_URL = 'https://cdn.jsdelivr.net/npm/hls.js@1.6.13/dist/hls.min.js';

      const CONFIG = {
        AUTOHIDE_MS: 4000,
        MAX_BEHIND_SEC: 20,
        TARGET_BEHIND_SEC: 2.5,
        CATCHUP_DELAY_MS: 1200,
        ERROR_RETRY_MS: 2000,
        HARD_RESYNC_COOLDOWN_MS: 8000,
        STALL_RELOAD_MS: 6500,
      };

      /* =====================================================
         UTILS
         ===================================================== */
      const $ = (id) => document.getElementById(id);

      const isIOS = (() => {
        const ua = navigator.userAgent || '';
        const iOSDevice = /iP(ad|hone|od)/.test(ua);
        const iPadOS = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
        return iOSDevice || iPadOS;
      })();

      const isTouchDevice = (() => {
        return (
          'ontouchstart' in window ||
          navigator.maxTouchPoints > 0 ||
          navigator.msMaxTouchPoints > 0
        );
      })();

      const prefersReducedMotion = (() => {
        try {
          return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        } catch {
          return false;
        }
      })();

      const safeCall = (fn) => {
        try { fn(); } catch { /* noop */ }
      };

      /* =====================================================
         ELEMENTS
         ===================================================== */
      const elements = {
        wrapper: $('videoWrapper'),
        video: $('liveVideo'),
        loadingOverlay: $('loadingOverlay'),
        tapLayer: $('tapLayer'),
        osdBtn: $('osdBtn'),
        fsBtn: $('fsBtn'),
        fsCurtain: $('fsCurtain'),
        pageCurtain: $('pageCurtain'),
      };

      if (!elements.wrapper || !elements.video) {
        console.error('Elementi video non trovati');
        return;
      }

      /* =====================================================
         STATE
         ===================================================== */
      const state = {
        autoHideTimer: null,
        lastCatchUpAt: 0,
        lastHiddenAt: 0,
        lastHardResyncAt: 0,
        touchMode: isTouchDevice,
        // HLS
        hls: null,
        usingNativeHls: false,
        // stall watchdog
        stallTimer: null,
      };

      /* =====================================================
         UI HELPERS
         ===================================================== */
      const setReady = (ready) => {
        elements.wrapper.classList.toggle('is-ready', ready);
        if (elements.loadingOverlay) {
          elements.loadingOverlay.setAttribute('aria-hidden', ready ? 'true' : 'false');
        }
      };

      const setPausedUI = () => {
        elements.wrapper.classList.toggle('is-paused', !!elements.video.paused);
      };

      const clearAutoHide = () => {
        if (state.autoHideTimer) {
          clearTimeout(state.autoHideTimer);
          state.autoHideTimer = null;
        }
      };

      const scheduleAutoHide = () => {
        clearAutoHide();
        state.autoHideTimer = setTimeout(() => {
          // Non nascondere se in pausa
          if (!elements.video.paused) {
            hideControls();
          }
        }, CONFIG.AUTOHIDE_MS);
      };

      const showControls = () => {
        elements.wrapper.classList.add('controls-visible');
        scheduleAutoHide();
      };

      const hideControls = () => {
        elements.wrapper.classList.remove('controls-visible');
        clearAutoHide();
      };

      const toggleControls = () => {
        if (elements.wrapper.classList.contains('controls-visible')) {
          hideControls();
        } else {
          showControls();
        }
      };

      const bumpControlsTimer = () => {
        showControls();
      };

      const curtainOn = (el) => {
        if (!el) return;
        el.style.opacity = '1';
        el.style.pointerEvents = 'auto';
      };

      const curtainOff = (el) => {
        if (!el) return;
        el.style.opacity = '0';
        el.style.pointerEvents = 'none';
      };

      /* =====================================================
         FULLSCREEN
         ===================================================== */
      const isFullscreen = () => {
        // Standard Fullscreen API (desktop/android)
        if (document.fullscreenElement) return true;
        // Vendor prefissi (vecchi)
        const anyDoc = document;
        if (anyDoc.webkitFullscreenElement || anyDoc.mozFullScreenElement) return true;
        // iOS video fullscreen (non usa Fullscreen API)
        if (isIOS && 'webkitDisplayingFullscreen' in elements.video) {
          return !!elements.video.webkitDisplayingFullscreen;
        }
        return false;
      };

      const lockOrientation = async (orientation) => {
        try {
          if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock(orientation);
          }
        } catch {
          // Ignora: non supportato o permessi negati
        }
      };

      const unlockOrientation = () => {
        try {
          if (screen.orientation && screen.orientation.unlock) {
            screen.orientation.unlock();
          }
        } catch {
          // Ignora
        }
      };

      const enterFullscreen = async () => {
        // iOS: solo video fullscreen nativo (webkitEnterFullscreen)
        if (isIOS && typeof elements.video.webkitEnterFullscreen === 'function') {
          curtainOn(elements.fsCurtain);
          curtainOn(elements.pageCurtain);
          // In iOS, l'orientamento è gestito dal sistema; lock può fallire
          safeCall(() => elements.video.webkitEnterFullscreen());
          setTimeout(() => {
            curtainOff(elements.fsCurtain);
            curtainOff(elements.pageCurtain);
          }, 650);
          return;
        }

        // Altri browser: fullscreen sul wrapper (così manteniamo UI/overlay)
        const el = elements.wrapper;
        const req = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen;
        if (req) {
          curtainOn(elements.fsCurtain);
          await req.call(el);
        }
      };

      const exitFullscreen = async () => {
        // iOS
        if (isIOS && typeof elements.video.webkitExitFullscreen === 'function') {
          safeCall(() => elements.video.webkitExitFullscreen());
          return;
        }
        const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen;
        if (exit) {
          await exit.call(document);
        }
      };

      const toggleFullscreen = async () => {
        if (isFullscreen()) {
          curtainOn(elements.pageCurtain);
          await exitFullscreen();
          unlockOrientation();
          setTimeout(() => curtainOff(elements.pageCurtain), 650);
        } else {
          await enterFullscreen();
          // Prova a bloccare in landscape (funziona soprattutto su Android)
          await lockOrientation('landscape');
          setTimeout(() => curtainOff(elements.fsCurtain), 650);
        }
      };

      const onFullscreenChange = async () => {
        if (!state.touchMode) return;

        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
          curtainOn(elements.fsCurtain);
          await lockOrientation('landscape');
        } else {
          curtainOn(elements.pageCurtain);
          unlockOrientation();
        }

        setTimeout(() => {
          curtainOff(elements.fsCurtain);
          curtainOff(elements.pageCurtain);
        }, 650);
      };

      document.addEventListener('fullscreenchange', onFullscreenChange);
      document.addEventListener('webkitfullscreenchange', onFullscreenChange);

      // iOS fullscreen events (solo su <video>)
      elements.video.addEventListener('webkitbeginfullscreen', () => {
        curtainOn(elements.fsCurtain);
        curtainOn(elements.pageCurtain);
      });
      elements.video.addEventListener('webkitendfullscreen', () => {
        setTimeout(() => {
          curtainOff(elements.fsCurtain);
          curtainOff(elements.pageCurtain);
        }, 250);
      });

      /* =====================================================
         HLS (native HLS su Safari/iOS; Hls.js sugli altri)
         ===================================================== */
      const canUseNativeHls = () => {
        // Safari/iOS: supporta nativamente application/vnd.apple.mpegurl
        const v = elements.video;
        const t1 = v.canPlayType('application/vnd.apple.mpegurl');
        const t2 = v.canPlayType('application/x-mpegURL');
        return (t1 && t1 !== 'no') || (t2 && t2 !== 'no');
      };

      const loadScriptOnce = (() => {
        const cache = new Map();
        return (src) => {
          if (cache.has(src)) return cache.get(src);
          const p = new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src;
            s.async = true;
            s.onload = () => resolve();
            s.onerror = () => reject(new Error('Impossibile caricare: ' + src));
            document.head.appendChild(s);
          });
          cache.set(src, p);
          return p;
        };
      })();

      const destroyHls = () => {
        if (state.hls) {
          try {
            state.hls.destroy();
          } catch {
            // Ignora
          }
          state.hls = null;
        }
      };

      const tryPlay = async () => {
        try {
          await elements.video.play();
        } catch {
          // Autoplay bloccato: mostra controlli e lascia in pausa
          setPausedUI();
          showControls();
        }
      };

      const handleHlsJsError = (data) => {
        if (!data || !data.fatal || !state.hls) return;

        const Hls = window.Hls;
        // Recupero consigliato dalla doc: startLoad() per network, recoverMediaError() per media
        if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
          try {
            state.hls.startLoad();
          } catch {
            hardResyncToLive('hls-network-fatal');
          }
          return;
        }
        if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
          try {
            state.hls.recoverMediaError();
          } catch {
            hardResyncToLive('hls-media-fatal');
          }
          return;
        }

        // Altri fatal: ricrea tutto
        hardResyncToLive('hls-fatal');
      };

      const initStream = async () => {
        destroyHls();
        state.usingNativeHls = canUseNativeHls();

        // Sempre: reset state "ready" finché non parte
        setReady(false);

        if (state.usingNativeHls) {
          // Safari/iOS: HLS nativo (più stabile e fullscreen OK)
          elements.video.src = STREAM_URL;
          safeCall(() => elements.video.load());
          await tryPlay();
          return;
        }

        // Altri browser: Hls.js (standard di settore per HLS via MSE)
        await loadScriptOnce(HLS_JS_URL);

        if (!window.Hls || !window.Hls.isSupported()) {
          // Fallback: prova src diretto (alcuni browser/TV box supportano HLS nativo)
          elements.video.src = STREAM_URL;
          safeCall(() => elements.video.load());
          await tryPlay();
          return;
        }

        const Hls = window.Hls;

        const hls = new Hls({
          startPosition: -1,
          maxBufferLength: 15,
          maxBufferHole: 0.5,
          liveSyncDurationCount: 3,
          liveMaxLatencyDurationCount: 10,
          liveDurationInfinity: true,
          enableWorker: true,
        });

        state.hls = hls;

        hls.attachMedia(elements.video);
        hls.on(Hls.Events.MEDIA_ATTACHED, () => {
          hls.loadSource(STREAM_URL);
        });
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          tryPlay();
        });
        hls.on(Hls.Events.ERROR, (evt, data) => {
          handleHlsJsError(data);
        });
      };

      /* =====================================================
         LIVE CATCH-UP
         ===================================================== */
      const getLiveEdge = () => {
        // Con Hls.js possiamo usare liveSyncPosition quando disponibile
        if (state.hls && typeof state.hls.liveSyncPosition === 'number' && !Number.isNaN(state.hls.liveSyncPosition)) {
          return state.hls.liveSyncPosition;
        }
        const s = elements.video.seekable;
        if (!s || s.length === 0) return null;
        return s.end(s.length - 1);
      };

      const catchUpToLiveIfNeeded = (force = false) => {
        const now = Date.now();
        if (!force && now - state.lastCatchUpAt < 1000) return;
        state.lastCatchUpAt = now;

        if (elements.video.paused) return;

        const liveEdge = getLiveEdge();
        if (liveEdge === null) return;

        const behind = liveEdge - elements.video.currentTime;

        if (behind > CONFIG.MAX_BEHIND_SEC) {
          // Troppo indietro: salta vicino al live edge
          safeCall(() => {
            elements.video.currentTime = Math.max(0, liveEdge - CONFIG.TARGET_BEHIND_SEC);
          });
          return;
        }

        // Se siamo ancora un po' indietro, nudgia (solo se forzato)
        if (force && behind > (CONFIG.TARGET_BEHIND_SEC + 1)) {
          safeCall(() => {
            elements.video.currentTime = Math.max(0, liveEdge - CONFIG.TARGET_BEHIND_SEC);
          });
        }
      };

      /* =====================================================
         HARD RESYNC (ricrea lo stream)
         ===================================================== */
      const hardResyncToLive = (reason = 'manual') => {
        const now = Date.now();
        if (now - state.lastHardResyncAt < CONFIG.HARD_RESYNC_COOLDOWN_MS) return;
        state.lastHardResyncAt = now;

        // Evita loop su iOS con fullscreen
        if (isIOS && elements.video.webkitDisplayingFullscreen) return;

        setReady(false);

        // Ricrea lo stream: è la via più robusta contro “stuck” su mobile
        initStream().then(() => {
          setTimeout(() => catchUpToLiveIfNeeded(true), CONFIG.CATCHUP_DELAY_MS);
        });
      };

      /* =====================================================
         STALL WATCHDOG
         ===================================================== */
      const clearStallTimer = () => {
        if (state.stallTimer) {
          clearTimeout(state.stallTimer);
          state.stallTimer = null;
        }
      };

      const armStallTimer = () => {
        clearStallTimer();
        if (elements.video.paused) return;

        state.stallTimer = setTimeout(() => {
          hardResyncToLive('stall');
        }, CONFIG.STALL_RELOAD_MS);
      };

      /* =====================================================
         UI EVENTS
         ===================================================== */
      elements.tapLayer?.addEventListener('click', (e) => {
        e.preventDefault();
        toggleControls();
      }, { passive: false });

      elements.osdBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        showControls();

        if (elements.video.paused) {
          tryPlay().then(() => catchUpToLiveIfNeeded(true));
        } else {
          elements.video.pause();
        }
      }, { passive: false });

      elements.fsBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        showControls();
        if (state.touchMode) {
          curtainOn(elements.fsCurtain);
          curtainOn(elements.pageCurtain);
        }
        toggleFullscreen();
      }, { capture: true, passive: false });

      // Interazione utente: mostra controlli e reset timer
      ['pointerdown', 'mousemove', 'keydown'].forEach((evtName) => {
        document.addEventListener(evtName, () => {
          bumpControlsTimer();
        }, { passive: true });
      });

      /* =====================================================
         VIDEO EVENTS
         ===================================================== */
      elements.video.addEventListener('loadedmetadata', () => {
        setPausedUI();
        setTimeout(() => catchUpToLiveIfNeeded(true), 300);
      });

      elements.video.addEventListener('playing', () => {
        setPausedUI();
        setReady(true);
        bumpControlsTimer();
        clearStallTimer();
      });

      elements.video.addEventListener('pause', () => {
        setPausedUI();
        showControls();
        clearStallTimer();
      });

      elements.video.addEventListener('waiting', () => {
        armStallTimer();
      });

      elements.video.addEventListener('stalled', () => {
        armStallTimer();
      });

      elements.video.addEventListener('error', () => {
        // Per native HLS: prova hard resync
        if (!state.hls) {
          setReady(false);
          setTimeout(() => hardResyncToLive('native-error'), CONFIG.ERROR_RETRY_MS);
        }
      });

      // Periodic catch-up
      setInterval(() => catchUpToLiveIfNeeded(false), 2000);

      /* =====================================================
         VISIBILITY / NETWORK
         ===================================================== */
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          state.lastHiddenAt = Date.now();
          return;
        }

        // Tornato in foreground: se è stato in background a lungo, ricarica
        const hiddenFor = Date.now() - state.lastHiddenAt;
        if (hiddenFor > 4500) {
          hardResyncToLive('resume');
        } else {
          // piccolo nudging
          setTimeout(() => catchUpToLiveIfNeeded(true), 350);
        }
      });

      window.addEventListener('online', () => {
        hardResyncToLive('online');
      });

      window.addEventListener('pagehide', () => {
        // iOS: libera risorse
        destroyHls();
      });

      /* =====================================================
         PARTICLES (effetto natalizio) - non bloccare il primo paint
         ===================================================== */
      const createParticles = () => {
          const container = $('particlesContainer');
          if (!container) return;

          // Ricrea (evita duplicati su resize/orientamento)
          container.textContent = '';

          const isMobile = window.innerWidth < 768;
          const snowCount = isMobile ? 35 : 70;
          const emberCount = isMobile ? 15 : 30;
          const speedModifier = isMobile ? 1.5 : 1;

          // Usa DocumentFragment per performance
          const fragment = document.createDocumentFragment();

          // Fiocchi di neve
          for (let i = 0; i < snowCount; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            const size = Math.random() * 3 + 2;
            flake.style.cssText = `
              width: ${size}px;
              height: ${size}px;
              left: ${Math.random() * 120 - 10}vw;
              animation: fall ${(Math.random() * 4 + 4) * speedModifier}s linear infinite;
              animation-delay: -${Math.random() * 5}s;
            `;
            fragment.appendChild(flake);
          }

          // Embers
          const animations = ['riseRight', 'riseLeft', 'riseZigZag'];
          for (let i = 0; i < emberCount; i++) {
            const ember = document.createElement('div');
            ember.className = 'ember';
            const size = Math.random() * 4 + 3;
            const randomAnim = animations[Math.floor(Math.random() * animations.length)];
            ember.style.cssText = `
              width: ${size}px;
              height: ${size}px;
              left: ${Math.random() * 100}vw;
              animation: ${randomAnim} ${(Math.random() * 6 + 6) * speedModifier}s linear infinite;
              animation-delay: -${Math.random() * 10}s;
            `;
            fragment.appendChild(ember);
          }

          container.appendChild(fragment);
        };

      const scheduleParticles = () => {
        if (prefersReducedMotion) return;
        const run = () => createParticles();

        if ('requestIdleCallback' in window) {
          // @ts-ignore
          window.requestIdleCallback(run, { timeout: 1500 });
        } else {
          setTimeout(run, 500);
        }
      };

      window.addEventListener('resize', () => {
        scheduleParticles();
      }, { passive: true });

      /* =====================================================
         INIT
         ===================================================== */
      const init = () => {
        // Stato iniziale
        setReady(false);
        setPausedUI();
        hideControls();

        // Particles dopo il primo paint
        scheduleParticles();

        // Avvia stream
        initStream();
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
