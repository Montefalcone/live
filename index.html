<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="google-site-verification" content="DLjKDn5UupGNdRgZXo9CuMc0Sg1S1aULxDJfIHT9tYo" />
  <meta charset="UTF-8">

  <!-- Zoom riabilitato -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <title>Webcam Montefalcone di Val Fortore - LIVE</title>

  <meta name="description" content="Guarda la webcam in diretta dal Comune di Montefalcone. Vista panoramica live, condizioni meteo attuali e immagini in tempo reale dal centro storico.">
  <meta name="keywords" content="webcam montefalcone, meteo montefalcone, comune di montefalcone live, telecamera diretta">
  <meta property="og:title" content="Webcam Montefalcone Live">
  <meta property="og:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta property="og:image" content="https://www.webcammontefalconedivalfortore.it/p.png">
  <meta name="robots" content="index, follow">

  <script type="module" src="https://cdn.jsdelivr.net/npm/media-chrome@4/+esm"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/hls-video-element@1/+esm"></script>

  <!-- Google Font: Poppins (per il badge LIVE) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- BLOCCO SCORRIMENTO (senza disabilitare pinch-zoom) --- */
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      position: fixed;
      top: 0; left: 0;
      overscroll-behavior: none;
      background-color: #000;
    }

    /* --- FONT --- */
    @font-face {
      font-family: 'MerryChristmasFont';
      src: url('last.otf') format('opentype');
      font-display: swap;
    }

    /* --- LAYOUT PRINCIPALE --- */
    #main-container {
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      position: relative; z-index: 20;
      transition: all 0.5s ease;
    }

    /* --- SFONDO (Satinato) --- */
    #bg-static {
      position: absolute;
      top: -10%; left: -10%; width: 120%; height: 120%;
      background-image: url("1a.webp");
      background-size: cover; background-position: center;
      z-index: 0;
      filter: brightness(0.65) contrast(1.15) saturate(1.1);
      animation: driftingWorld 80s ease-in-out infinite alternate;
      pointer-events: none;
    }
    @keyframes driftingWorld {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-2%, 2%) scale(1.05); }
    }

    /* --- ELEMENTI UI COMUNI --- */
    .municipality-logo, .festive-message, .warm-flicker, .vignette, .particles-container {
      transition: opacity 0.5s ease;
      opacity: 1;
      pointer-events: none;
    }

    /* --- LOGO --- */
    .municipality-logo {
      width: 110px; height: auto;
      margin-bottom: 15px; z-index: 30;
      filter: brightness(1.1) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
    }

    /* --- MESSAGGIO --- */
    .festive-message {
      font-family: 'MerryChristmasFont', serif;
      color: #ffffff; text-align: center;
      font-size: 3.5rem; line-height: 1.2; margin-bottom: 25px;
      text-shadow: 2px 2px 4px #000, 0 0 25px rgba(255, 255, 255, 0.6);
      z-index: 30; padding: 0 20px; width: 100%; box-sizing: border-box;
    }

    /* --- VIDEO WRAPPER --- */
    .video-wrapper {
      position: relative;
      width: auto; height: 60%;
      aspect-ratio: 16/9;
      border-radius: 15px; overflow: hidden; background: #000;
      box-shadow: 0 0 30px rgba(255, 220, 150, 0.2), 0 40px 80px rgba(0,0,0,0.95);
      border: 1px solid rgba(255, 255, 255, 0.15); z-index: 30;
      pointer-events: auto;
      transition: all 0.3s ease-out;
      will-change: width, height;
    }

    .video-wrapper:fullscreen,
    .video-wrapper:-webkit-full-screen,
    .video-wrapper:-moz-full-screen {
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      width: 100% !important;
      height: 100% !important;
    }

    /* Assicura che il controller riempia in fullscreen */
    #videoWrapper:fullscreen #mc,
    #videoWrapper:-webkit-full-screen #mc,
    #videoWrapper:-moz-full-screen #mc {
      width: 100% !important;
      height: 100% !important;
    }

    /* --- STILI MEDIA CHROME (Player Interno) --- */
    #videoWrapper media-controller {
      width: 100%; height: 100%;
      display: block; position: relative;
      background: #000;

      /* NIENTE tooltip (rimuove "Enter Fullscreen") */
      --media-tooltip-display: none;
    }

    #videoWrapper hls-video {
      width: 100%; height: 100%;
      display: block; background: #000;
      object-fit: contain;
    }

    /* Layer per tap */
    #videoWrapper .tap-layer {
      position: absolute; inset: 0; z-index: 10;
      cursor: default;
    }

    /* Control bar minimale */
    #videoWrapper media-control-bar {
      position: absolute; left: 0; right: 0; bottom: 0;
      z-index: 30;
      padding: 12px 12px;
      display: flex; align-items: center; justify-content: flex-end;
      gap: 10px;
      background: linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,0));

      transition: opacity 180ms ease;
    }

    /* Mobile: controlli a tap (tap1 mostra, tap2 nasconde) */
    #videoWrapper.touch-ui media-control-bar {
      opacity: 0;
      pointer-events: none;
    }
    #videoWrapper.touch-ui.controls-visible media-control-bar {
      opacity: 1;
      pointer-events: auto;
    }

    #videoWrapper media-fullscreen-button {
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.35);

      /* blur leggermente ridotto */
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);

      cursor: pointer;

      /* stabilizza rendering (riduce ritardi di compositing su mobile) */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      will-change: transform;
    }

    /* LIVE Badge */
    #videoWrapper .live-badge {
      position: absolute; left: 14px; bottom: 14px; z-index: 31;
      display: inline-flex; align-items: center; gap: 8px;

      padding: 8px 12px;
      border-radius: 999px;

      color: #fff;
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 700;
      font-size: 12px;
      line-height: 1;
      letter-spacing: .14em;
      text-transform: uppercase;

      background: rgba(0, 0, 0, 0.18);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 28px rgba(0,0,0,.28);

      /* blur leggermente ridotto */
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);

      pointer-events: none;

      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      will-change: transform;
    }

    #videoWrapper .live-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #ff2b2b;
      box-shadow: 0 0 12px rgba(255, 43, 43, .95);
      animation: livePulse 1.6s infinite;
    }
    @keyframes livePulse { 0%{opacity:1} 50%{opacity:.45} 100%{opacity:1} }

    /* OSD Centrale */
    #videoWrapper .osd {
      position: absolute; inset: 0; z-index: 20;
      display: flex; align-items: center; justify-content: center;
      pointer-events: none;
      opacity: 0; transform: scale(.98);
      transition: opacity 140ms ease, transform 140ms ease;

      will-change: opacity, transform;
      transform: translateZ(0) scale(.98);
      -webkit-transform: translateZ(0) scale(.98);
    }

    #videoWrapper .osd-chip {
      width: 84px; height: 84px; border-radius: 999px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.22);

      /* blur leggermente ridotto */
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);

      pointer-events: auto;
      cursor: pointer;

      appearance: none;
      -webkit-appearance: none;
      padding: 0;
      margin: 0;
      font: inherit;
      color: inherit;

      /* stabilizza (riduce “blur in ritardo”) */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      will-change: transform;
    }
    #videoWrapper .osd-chip::-moz-focus-inner { border: 0; padding: 0; }
    #videoWrapper .osd-chip:focus-visible {
      outline: 2px solid rgba(255,255,255,.35);
      outline-offset: 2px;
    }

    #videoWrapper .osd-icon {
      width: 40px; height: 40px;
      fill: #fff; opacity: .95;
    }

    /* OSD visibile: pausa, flash, oppure mobile quando controlli visibili */
    #videoWrapper.is-paused .osd,
    #videoWrapper.flash .osd,
    #videoWrapper.osd-visible .osd {
      opacity: 1; transform: translateZ(0) scale(1);
      -webkit-transform: translateZ(0) scale(1);
    }

    #videoWrapper .osd-icon.play { display: none; }
    #videoWrapper.is-paused .osd-icon.play { display: block; }
    #videoWrapper.is-paused .osd-icon.pause { display: none; }

    /* Pre-warm: evita “mezzo secondo dopo arriva il blur” su alcuni mobile */
    #videoWrapper.prewarm .osd {
      opacity: 0.01 !important;
      transform: translateZ(0) scale(1) !important;
      -webkit-transform: translateZ(0) scale(1) !important;
      transition: none !important;
    }

    /* Curtain transizione fullscreen (copre scatti brutti) */
    #pageCurtain, #fsCurtain {
      background: #000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 260ms ease;
    }
    #pageCurtain {
      position: fixed;
      inset: 0;
      z-index: 9999;
    }
    #fsCurtain {
      position: absolute;
      inset: 0;
      z-index: 200;
      border-radius: inherit;
    }
    #pageCurtain.on, #fsCurtain.on { opacity: 1; }
    #pageCurtain.instant, #fsCurtain.instant { transition: none !important; }

    /* --- MOBILE MEDIA QUERIES --- */
    @media (max-width: 768px) and (orientation: portrait) {
      #main-container { justify-content: flex-start; padding-top: 16vh; }

      .municipality-logo { width: 75px; margin-bottom: 10px; }
      .festive-message { font-size: 6vw; line-height: 1.4; margin-bottom: 20px; }
      .video-wrapper { width: 95%; height: auto; }
      #bg-static { animation: driftingWorldMobile 35s ease-in-out infinite alternate; }
    }
    @keyframes driftingWorldMobile {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-3%, 0) scale(1.15); }
    }

    @media screen and (orientation: landscape) and (max-height: 600px) {
      .municipality-logo, .festive-message, #bg-static, .warm-flicker, .vignette, .particles-container {
        display: none !important;
      }
      #main-container { padding: 0 !important; justify-content: center !important; background: #000; }
      .video-wrapper {
        width: 100vw; height: 100vh;
        border: none; border-radius: 0;
      }
    }

    /* --- EFFETTI --- */
    .warm-flicker {
      position: absolute; inset: 0;
      background: radial-gradient(circle, rgba(255, 180, 50, 0.15), transparent 80%);
      z-index: 2; pointer-events: none;
      mix-blend-mode: overlay;
      animation: firePulse 4s ease-in-out infinite alternate;
    }
    @keyframes firePulse { 0% { opacity: 0.1; } 100% { opacity: 0.5; } }

    .particles-container { position: absolute; inset: 0; pointer-events: none; z-index: 5; overflow: hidden; }
    .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.9; box-shadow: 0 0 3px white; }
    .ember { position: absolute; bottom: -20px; background: #ffcc00; border-radius: 50%; opacity: 0; filter: blur(2px); }
    .vignette {
      position: absolute; inset: 0;
      background: radial-gradient(circle at center, transparent 40%, rgba(0,0,0,0.7) 85%, black 100%);
      z-index: 6; pointer-events: none;
    }

    @keyframes fall { 0% { transform: translate(0, -10vh); } 100% { transform: translate(15vw, 110vh); } }
    @keyframes riseRight { 0% { transform: translateY(0) translateX(0); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(-90vh) translateX(15vw); opacity: 0; } }
    @keyframes riseLeft { 0% { transform: translateY(0) translateX(0); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(-90vh) translateX(-15vw); opacity: 0; } }
    @keyframes riseZigZag { 0% { transform: translateY(0) translateX(0); opacity: 0; } 25% { transform: translateY(-20vh) translateX(5vw); opacity: 0.8; } 75% { transform: translateY(-60vh) translateX(-5vw); opacity: 0.4; } 100% { transform: translateY(-90vh) translateX(0); opacity: 0; } }

    /* Riduzione movimento */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
      .particles-container { display: none !important; }
    }
  </style>
</head>

<body>
  <div id="bg-static"></div>
  <div class="warm-flicker"></div>
  <div class="vignette"></div>
  <div class="particles-container" id="particlesContainer"></div>

  <div id="main-container">
    <img src="stemma2-removebg-preview.png" alt="Stemma Comune di Montefalcone" class="municipality-logo">

    <div class="festive-message">
      Il comune di Montefalcone di Val Fortore<br>
      augura a tutti Buone Feste
    </div>

    <div class="video-wrapper" id="videoWrapper">
      <media-controller
        id="mc"
        autohide="2"
        autohideovercontrols
        gesturesdisabled
        fullscreenelement="videoWrapper"
        defaultstreamtype="live"
        liveedgeoffset="20"
        seektoliveoffset="3"
      >
        <hls-video
          id="liveVideo"
          slot="media"
          src="https://live.webcammontefalconedivalfortore.it/memfs/58e0bcbe-f1bd-4c8b-85f7-b4566a3e5392.m3u8"
          autoplay
          muted
          playsinline
          preload="auto"
          crossorigin="anonymous">
        </hls-video>

        <div class="tap-layer" id="tapLayer" aria-hidden="true" noautohide></div>

        <div class="live-badge" aria-hidden="true" noautohide>
          <span class="live-dot"></span>
          <span>LIVE</span>
        </div>

        <div class="osd" noautohide>
          <button class="osd-chip" id="osdBtn" type="button" aria-label="Pausa">
            <svg class="osd-icon play" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 5v14l11-7z"></path>
            </svg>
            <svg class="osd-icon pause" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
            </svg>
          </button>
        </div>

        <media-control-bar>
          <media-fullscreen-button id="fsBtn" notooltip tooltipplacement="none"></media-fullscreen-button>
        </media-control-bar>
      </media-controller>

      <!-- Curtain dentro al player (copre transizione in fullscreen) -->
      <div id="fsCurtain" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Curtain pagina (serve soprattutto per uscita fullscreen su mobile) -->
  <div id="pageCurtain" aria-hidden="true"></div>

  <script type="module">
    (async () => {
      const safeWhenDefined = (tag) => {
        try { return customElements.whenDefined(tag); }
        catch { return Promise.resolve(); }
      };

      await Promise.all([
        safeWhenDefined('media-controller'),
        safeWhenDefined('media-fullscreen-button'),
        safeWhenDefined('hls-video'),
      ]);

      const wrapper = document.getElementById('videoWrapper');
      const mc = document.getElementById('mc');
      const video = document.getElementById('liveVideo');
      const tapLayer = document.getElementById('tapLayer');
      const fsBtn = document.getElementById('fsBtn');
      const osdBtn = document.getElementById('osdBtn');
      const fsCurtain = document.getElementById('fsCurtain');
      const pageCurtain = document.getElementById('pageCurtain');

      if (!wrapper || !mc || !video) return;

      const prefersReducedMotion = !!window.matchMedia?.('(prefers-reduced-motion: reduce)').matches;

      const isTouchLike = () => (
        !!window.matchMedia?.('(hover: none) and (pointer: coarse)').matches ||
        (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) ||
        window.innerWidth < 768
      );

      const touchMode = isTouchLike();

      // Mobile: disabilita autohide interno, gestiamo noi tap 1/tap 2
      if (touchMode) {
        wrapper.classList.add('touch-ui');
        mc.setAttribute('autohide', '-1');
      }

      // Pre-warm blur (evita ritardo su iOS/alcuni Android)
      wrapper.classList.add('prewarm');
      requestAnimationFrame(() => {
        setTimeout(() => wrapper.classList.remove('prewarm'), 80);
      });

      // ---------- UI helpers ----------
      let flashTimer = null;

      function updateOsdAriaLabel() {
        if (!osdBtn) return;
        osdBtn.setAttribute('aria-label', video.paused ? 'Play' : 'Pausa');
      }

      function setPausedUI() {
        wrapper.classList.toggle('is-paused', !!video.paused);
        updateOsdAriaLabel();

        // Se è in pausa su mobile, controlli sempre visibili
        if (touchMode && video.paused) {
          showMobileControls(true);
        }
      }

      function flashOSD(ms = 420) {
        wrapper.classList.add('flash');
        clearTimeout(flashTimer);
        flashTimer = setTimeout(() => wrapper.classList.remove('flash'), ms);
      }

      function togglePlayPause() {
        if (video.paused) {
          // Prima di ripartire, forza live
          enforceLive({ force: true });

          video.play().catch(() => {});
          // Secondo tentativo “catch-up” dopo avvio
          setTimeout(() => enforceLive({ force: true }), 900);
        } else {
          video.pause();
        }
      }

      // ---------- Mobile tap 1 / tap 2 ----------
      let mobileControlsVisible = false;

      function showMobileControls(withOSD = true) {
        mobileControlsVisible = true;
        wrapper.classList.add('controls-visible');
        if (withOSD) wrapper.classList.add('osd-visible');
      }

      function hideMobileControls() {
        // Se in pausa, NON nascondiamo (sempre raggiungibile il play)
        if (video.paused) return;

        mobileControlsVisible = false;
        wrapper.classList.remove('controls-visible');
        wrapper.classList.remove('osd-visible');
      }

      function toggleMobileControls() {
        if (!mobileControlsVisible) showMobileControls(true);
        else hideMobileControls();
      }

      // Tap sul player
      tapLayer?.addEventListener('click', () => {
        if (touchMode) {
          toggleMobileControls();
          return;
        }
        togglePlayPause();
        flashOSD(420);
      });

      // Click sul bottone centrale (solo qui fa play/pausa su mobile)
      osdBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        togglePlayPause();

        // Su desktop fa il flash, su mobile lascia visibili (poi tap2 nasconde)
        if (!touchMode) flashOSD(420);
        else showMobileControls(true);
      });

      // Stato iniziale + update
      video.addEventListener('loadedmetadata', setPausedUI);
      video.addEventListener('play', () => {
        setPausedUI();
        if (!touchMode) flashOSD(420);
      });
      video.addEventListener('pause', () => {
        setPausedUI();
        // Se pausa su mobile: mostriamo controlli (coerente)
        if (touchMode) showMobileControls(true);
        if (!touchMode) flashOSD(420);
      });

      // Retry leggero se il live cade
      video.addEventListener('error', () => {
        setTimeout(() => {
          try {
            video.load();
            video.play().catch(() => {});
            setTimeout(() => enforceLive({ force: true }), 900);
          } catch (e) {}
        }, 1500);
      });

      // ---------- Fullscreen + orientamento + transizione “curtain” ----------
      function isFullscreen() {
        return document.fullscreenElement || document.webkitFullscreenElement;
      }

      function curtainInstantOn(el) {
        if (!el) return;
        el.classList.add('instant');
        el.classList.add('on');
        // force reflow
        el.getBoundingClientRect();
        el.classList.remove('instant');
      }

      function curtainOff(el) {
        if (!el) return;
        el.classList.remove('on');
      }

      async function lockOrientation(mode) {
        try {
          if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock(mode);
          }
        } catch (e) {
          // iOS/Safari può non supportare o rifiutare: ignore
        }
      }

      function unlockOrientation() {
        try {
          if (screen.orientation && screen.orientation.unlock) {
            screen.orientation.unlock();
          }
        } catch (e) {}
      }

      // Prima del fullscreen toggle: accendi i curtain su mobile (copre lo “scatto”)
      fsBtn?.addEventListener('click', () => {
        if (!touchMode) return;
        curtainInstantOn(pageCurtain);
        curtainInstantOn(fsCurtain);
      }, { capture: true });

      async function onFullscreenChange() {
        const fs = !!isFullscreen();

        // Desktop: assicurati che in fullscreen la barra si autonasconda anche se “hover”
        // (autohideovercontrols è già in markup, qui solo per sicurezza)
        if (fs) mc.setAttribute('autohideovercontrols', '');
        else mc.setAttribute('autohideovercontrols', '');

        if (!touchMode) return;

        // Durante cambio: copri
        // - entrando: fsCurtain copre il fullscreen element
        // - uscendo: pageCurtain copre la pagina (per evitare “rotazione brutta”)
        curtainInstantOn(fsCurtain);
        if (!fs) curtainInstantOn(pageCurtain);

        if (fs) {
          await lockOrientation('landscape');
        } else {
          // niente lock portrait: spesso più brutto/instabile. Meglio unlock e coprire con curtain.
          unlockOrientation();
        }

        // lascia 1 attimo per stabilizzare e poi dissolvi
        setTimeout(() => {
          curtainOff(fsCurtain);
          curtainOff(pageCurtain);
        }, 90);
      }

      document.addEventListener('fullscreenchange', onFullscreenChange);
      document.addEventListener('webkitfullscreenchange', onFullscreenChange);

      // ---------- Sempre “in diretta” (max ~20s) ----------
      const MAX_LATENCY_SEC = 20;     // tolleranza massima
      const LIVE_FUDGE_SEC = 2;       // ci posizioniamo un filo dietro il bordo live
      const CHECK_EVERY_MS = 5000;

      let liveWatchdog = null;

      function getSeekableEnd() {
        try {
          const s = video.seekable;
          if (s && s.length) return s.end(s.length - 1);
        } catch (e) {}
        return null;
      }

      function enforceLive({ force = false } = {}) {
        const liveEnd = getSeekableEnd();
        if (liveEnd == null) return false;

        const behind = liveEnd - (video.currentTime || 0);

        // Se siamo molto indietro (o force), salta vicino al live
        if (force || behind > (MAX_LATENCY_SEC + 2)) {
          const target = Math.max(0, liveEnd - LIVE_FUDGE_SEC);
          try {
            video.currentTime = target;
            return true;
          } catch (e) {
            return false;
          }
        }
        return false;
      }

      function startLiveWatchdog() {
        if (liveWatchdog) return;
        liveWatchdog = setInterval(() => {
          // solo se sta suonando (o almeno non in pausa)
          if (!video.paused) enforceLive({ force: false });
        }, CHECK_EVERY_MS);
      }

      function stopLiveWatchdog() {
        if (!liveWatchdog) return;
        clearInterval(liveWatchdog);
        liveWatchdog = null;
      }

      video.addEventListener('playing', () => {
        enforceLive({ force: true });
        startLiveWatchdog();
      });

      video.addEventListener('pause', () => {
        stopLiveWatchdog();
      });

      // Quando torni sull’app/tab dopo tanto tempo: ri-aggancia alla live
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          enforceLive({ force: true });
          if (!video.paused) setTimeout(() => enforceLive({ force: true }), 900);
        }
      });

      window.addEventListener('focus', () => {
        enforceLive({ force: true });
        if (!video.paused) setTimeout(() => enforceLive({ force: true }), 900);
      });

      // ---------- PARTICELLE ----------
      function createParticles() {
        const container = document.getElementById('particlesContainer');
        if (!container) return;

        const isMobile = window.innerWidth < 768;
        const snowCount = isMobile ? 35 : 70;
        const emberCount = isMobile ? 15 : 30;
        const speedModifier = isMobile ? 1.5 : 1;

        for (let i = 0; i < snowCount; i++) {
          const flake = document.createElement('div');
          flake.classList.add('snowflake');
          const size = Math.random() * 3 + 2;
          flake.style.width = size + 'px'; flake.style.height = size + 'px';
          flake.style.left = (Math.random() * 120 - 10) + 'vw';
          const duration = (Math.random() * 4 + 4) * speedModifier;
          flake.style.animation = `fall ${duration}s linear infinite`;
          flake.style.animationDelay = '-' + (Math.random() * 5) + 's';
          container.appendChild(flake);
        }

        const animations = ['riseRight', 'riseLeft', 'riseZigZag'];
        for (let i = 0; i < emberCount; i++) {
          const ember = document.createElement('div');
          ember.classList.add('ember');
          const size = Math.random() * 4 + 3;
          ember.style.width = size + 'px'; ember.style.height = size + 'px';
          ember.style.left = Math.random() * 100 + 'vw';
          const duration = (Math.random() * 6 + 6) * speedModifier;
          const randomAnim = animations[Math.floor(Math.random() * animations.length)];
          ember.style.animation = `${randomAnim} ${duration}s linear infinite`;
          ember.style.animationDelay = '-' + (Math.random() * 10) + 's';
          container.appendChild(ember);
        }
      }

      if (!prefersReducedMotion) createParticles();

      // init UI
      setPausedUI();
    })();
  </script>
</body>
</html>
