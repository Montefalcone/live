<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-TileColor" content="#000000">
  
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <title>Webcam Montefalcone di Val Fortore</title>
  <meta name="description" content="Webcam in diretta dal Comune di Montefalcone. Vista panoramica e condizioni meteo attuali">
  <meta name="keywords" content="webcam montefalcone, meteo montefalcone, comune di montefalcone live, telecamera diretta">
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="DLjKDn5UupGNdRgZXo9CuMc0Sg1S1aULxDJfIHT9tYo">
  <link rel="canonical" href="https://www.webcammontefalconedivalfortore.it/">
  
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.webcammontefalconedivalfortore.it/">
  <meta property="og:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta property="og:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta property="og:image" content="https://www.webcammontefalconedivalfortore.it/p.png">
  <meta property="og:locale" content="it_IT">
  <meta property="og:site_name" content="Webcam Montefalcone">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta name="twitter:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta name="twitter:image" content="https://www.webcammontefalconedivalfortore.it/p.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://live.webcammontefalconedivalfortore.it" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js" as="script">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --blur-ui: 12px;
      --blur-play: 5px;
      --color-bg: #000;
      --color-live: #ff2b2b;
      --color-live-off: #666;
      --color-white: #fff;
      --color-border: rgba(255, 255, 255, 0.18);
      --radius-pill: 999px;
      --radius-video: 15px;
      --transition-fast: 150ms ease;
      --transition-medium: 260ms ease;
      --shadow-glow: 0 0 30px rgba(255, 220, 150, 0.2);
      --shadow-deep: 0 40px 80px rgba(0, 0, 0, 0.95);
      --shadow-button: 0 10px 28px rgba(0, 0, 0, 0.28);
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      overscroll-behavior: none;
      background-color: var(--color-bg);
      -webkit-font-smoothing: antialiased;
    }

    @font-face {
      font-family: 'MerryChristmasFont';
      src: url('last.otf') format('opentype');
      font-display: swap;
    }

    #main-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 20;
    }

    @media (min-width: 1024px) {
      #main-container {
        transform: scale(0.965);
        transform-origin: center top;
      }
    }

    #bg-static {
      position: absolute;
      inset: 0;
      background-image: url("1a.webp");
      background-size: cover;
      background-position: center;
      z-index: 0;
      filter: brightness(0.65);
      pointer-events: none;
    }

    @media (min-width: 769px) {
      #bg-static {
        top: -5%;
        left: -5%;
        width: 110%;
        height: 110%;
        animation: driftBg 60s ease-in-out infinite alternate;
        will-change: transform;
      }
    }

    @keyframes driftBg {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-2%, 1%) scale(1.03); }
    }

    .municipality-logo, .festive-message { pointer-events: none; }

    .municipality-logo {
      width: 110px;
      height: auto;
      margin-bottom: 15px;
      z-index: 30;
      filter: brightness(1.1) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
    }

    .festive-message {
      font-family: 'MerryChristmasFont', 'Brush Script MT', cursive, serif;
      color: var(--color-white);
      text-align: center;
      font-size: 3.5rem;
      line-height: 1.2;
      margin-bottom: 25px;
      text-shadow: 2px 2px 4px var(--color-bg), 0 0 25px rgba(255, 255, 255, 0.6);
      z-index: 30;
      padding: 0 20px;
      width: 100%;
    }

    .vignette {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.7) 85%, var(--color-bg) 100%);
      z-index: 6;
      pointer-events: none;
    }

    /* Particelle */
    .particles-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      overflow: hidden;
      contain: strict;
    }

    .snowflake {
      position: absolute;
      top: -10px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    @keyframes fall {
      0% { transform: translate3d(0, -10vh, 0); }
      100% { transform: translate3d(0, 110vh, 0); }
    }

    .ember {
      position: absolute;
      bottom: -20px;
      background: #ffaa00;
      border-radius: 50%;
      opacity: 0;
      will-change: transform, opacity;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    @keyframes rise {
      0% { transform: translate3d(0, 0, 0); opacity: 0; }
      15% { opacity: 0.7; }
      100% { transform: translate3d(10vw, -100vh, 0); opacity: 0; }
    }

    /* Video Player */
    .video-wrapper {
      position: relative;
      width: auto;
      height: 60%;
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-video);
      overflow: hidden;
      background: var(--color-bg);
      box-shadow: var(--shadow-glow), var(--shadow-deep);
      border: 1px solid var(--color-border);
      z-index: 30;
      pointer-events: auto;
    }

    .video-wrapper:fullscreen,
    .video-wrapper:-webkit-full-screen {
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      width: 100vw !important;
      height: 100vh !important;
    }

    #liveVideo {
      width: 100%;
      height: 100%;
      display: block;
      background: var(--color-bg);
      object-fit: contain;
    }

    .tap-layer {
      position: absolute;
      inset: 0;
      z-index: 10;
      cursor: default;
    }

    /* Loading Overlay con preview MOLTO BLURRATA */
    .loading-overlay {
      position: absolute;
      inset: 0;
      z-index: 80;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--color-bg);
      pointer-events: none;
      opacity: 1;
      visibility: visible;
      transition: opacity 300ms ease, visibility 0ms linear 0ms;
    }

    .video-wrapper.is-ready .loading-overlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity 300ms ease, visibility 0ms linear 300ms;
    }

    .loading-overlay .preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: blur(20px) brightness(0.5) saturate(0.8);
      transform: scale(1.1); /* Evita bordi bianchi dal blur */
      opacity: 1;
    }

    .loading-overlay .spinner-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      z-index: 2;
    }

    .loading-overlay .spinner {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.25);
      border-top-color: rgba(255, 255, 255, 0.9);
      animation: spin 0.8s linear infinite;
    }

    .loading-overlay .status-text {
      font-family: "Poppins", sans-serif;
      font-size: 11px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.85);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Control Bar */
    .control-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.75), transparent);
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .video-wrapper.controls-visible .control-bar {
      pointer-events: auto;
      opacity: 1;
    }

    .fs-btn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.20);
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--transition-fast);
    }

    .fs-btn:active { transform: scale(0.92); }
    .fs-btn svg { width: 20px; height: 20px; fill: var(--color-white); }
    .fs-btn .icon-exit { display: none; }
    .video-wrapper.is-fullscreen .fs-btn .icon-enter { display: none; }
    .video-wrapper.is-fullscreen .fs-btn .icon-exit { display: block; }

    /* Live Badge */
    .live-badge {
      position: absolute;
      left: 14px;
      bottom: 14px;
      z-index: 31;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-pill);
      color: var(--color-white);
      font-family: "Poppins", sans-serif;
      font-weight: 700;
      font-size: 12px;
      line-height: 1;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.18);
      border: 1px solid var(--color-border);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      pointer-events: none;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-live);
      box-shadow: 0 0 12px rgba(255, 43, 43, 0.95);
      animation: livePulse 1.6s infinite;
    }

    .video-wrapper.is-paused .live-dot,
    .video-wrapper.is-offline .live-dot {
      background: var(--color-live-off);
      box-shadow: none;
      animation: none;
    }

    @keyframes livePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* OSD */
    .osd {
      position: absolute;
      inset: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .osd-chip {
      width: 84px;
      height: 84px;
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      appearance: none;
      padding: 0;
      margin: 0;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.22);
      backdrop-filter: blur(var(--blur-play));
      -webkit-backdrop-filter: blur(var(--blur-play));
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 120ms ease, transform 120ms ease;
      pointer-events: none;
    }

    .video-wrapper.controls-visible .osd-chip {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    .osd-chip:active { transform: scale(0.92); }

    .osd-icon {
      width: 40px;
      height: 40px;
      fill: var(--color-white);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .osd-icon.play { display: none; }
    .video-wrapper.is-paused .osd-icon.play { display: block; }
    .video-wrapper.is-paused .osd-icon.pause { display: none; }

    /* Curtains */
    #pageCurtain, .fs-curtain {
      background: var(--color-bg);
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease;
    }

    #pageCurtain { position: fixed; inset: 0; z-index: 9999; }
    .fs-curtain { position: absolute; inset: 0; z-index: 200; border-radius: inherit; }
    #pageCurtain.on, .fs-curtain.on { opacity: 1; }

    /* Responsive */
    @media (max-width: 768px) and (orientation: portrait) {
      #main-container {
        justify-content: flex-start;
        padding-top: 18vh;
      }

      .municipality-logo { width: 75px; margin-bottom: 10px; }
      .festive-message { font-size: 6vw; line-height: 1.4; margin-bottom: 20px; }
      .video-wrapper { width: 95%; height: auto; }
      .osd-chip { width: 68px; height: 68px; }
      .osd-icon { width: 32px; height: 32px; }
      .fs-btn { width: 38px; height: 38px; }
      .live-badge { padding: 6px 10px; font-size: 10px; gap: 6px; }
      .live-dot { width: 6px; height: 6px; }
    }

    @media screen and (orientation: landscape) and (max-height: 600px) {
      .municipality-logo, .festive-message, #bg-static, .vignette, .particles-container {
        display: none !important;
      }

      #main-container {
        padding: 0 !important;
        justify-content: center !important;
        background: var(--color-bg);
      }

      .video-wrapper {
        width: 100vw;
        height: 100vh;
        border: none;
        border-radius: 0;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
      .particles-container { display: none !important; }
      .loading-overlay .spinner { animation: spin 0.8s linear infinite !important; }
    }
  </style>
</head>

<body>
  <div id="bg-static"></div>
  <div class="vignette"></div>
  <div class="particles-container" id="particlesContainer"></div>

  <div id="main-container">
    <img 
      src="stemma2-removebg-preview.png" 
      alt="Stemma Comune di Montefalcone di Val Fortore" 
      class="municipality-logo"
      width="110"
      height="110"
      loading="eager"
    >

    <div class="festive-message">
      Il comune di Montefalcone di Val Fortore<br>
      augura a tutti Buone Feste
    </div>

    <div class="video-wrapper" id="videoWrapper">
      <video
        id="liveVideo"
        playsinline
        muted
        preload="auto"
      ></video>

      <div class="loading-overlay" id="loadingOverlay">
        <img 
          class="preview" 
          src="https://www.webcammontefalconedivalfortore.it/p.png" 
          alt=""
          loading="eager"
        >
        <div class="spinner-container">
          <div class="spinner"></div>
          <div class="status-text" id="statusText">Connessione...</div>
        </div>
      </div>

      <div class="tap-layer" id="tapLayer"></div>

      <div class="live-badge">
        <span class="live-dot" id="liveDot"></span>
        <span>LIVE</span>
      </div>

      <div class="osd">
        <button class="osd-chip" id="osdBtn" type="button" aria-label="Play/Pausa">
          <svg class="osd-icon play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="osd-icon pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
      </div>

      <div class="control-bar">
        <button class="fs-btn" id="fsBtn" type="button" aria-label="Schermo intero">
          <svg class="icon-enter" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
          <svg class="icon-exit" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
        </button>
      </div>

      <div class="fs-curtain" id="fsCurtain"></div>
    </div>
  </div>

  <div id="pageCurtain"></div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>

  <script>
    (() => {
      'use strict';

      const STREAM_URL = 'https://live.webcammontefalconedivalfortore.it/memfs/58e0bcbe-f1bd-4c8b-85f7-b4566a3e5392.m3u8';

      // Config HLS ULTRA-AGGRESSIVA per avvio veloce
      const HLS_CONFIG = {
        // === AVVIO IMMEDIATO ===
        enableWorker: true,
        lowLatencyMode: false, // Disabilita per stabilità
        backBufferLength: 0,
        
        // === LIVE SYNC ===
        liveSyncDuration: 3,
        liveMaxLatencyDuration: 10,
        liveDurationInfinity: true,
        liveBackBufferLength: 0,
        
        // === BUFFER MINIMO per partire subito ===
        maxBufferLength: 5,           // Solo 5 sec buffer
        maxMaxBufferLength: 10,
        maxBufferSize: 10 * 1000000,  // 10MB
        maxBufferHole: 0.5,
        
        // === STARTUP VELOCE ===
        startLevel: -1,               // Auto (lascia decidere HLS)
        autoStartLoad: true,
        startPosition: -1,            // Live edge
        
        // === TIMEOUT BREVI ===
        manifestLoadingTimeOut: 5000,
        manifestLoadingMaxRetry: 2,
        manifestLoadingRetryDelay: 500,
        levelLoadingTimeOut: 5000,
        levelLoadingMaxRetry: 2,
        levelLoadingRetryDelay: 500,
        fragLoadingTimeOut: 8000,
        fragLoadingMaxRetry: 3,
        fragLoadingRetryDelay: 500,
      };

      const $ = id => document.getElementById(id);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      class LivePlayer {
        constructor() {
          this.wrapper = $('videoWrapper');
          this.video = $('liveVideo');
          this.tapLayer = $('tapLayer');
          this.osdBtn = $('osdBtn');
          this.fsBtn = $('fsBtn');
          this.fsCurtain = $('fsCurtain');
          this.pageCurtain = $('pageCurtain');
          this.statusText = $('statusText');

          this.hls = null;
          this.autoHideTimer = null;
          this.userPaused = false;
          this.isPlaying = false;
          
          // Keep-alive per mobile
          this.keepAliveInterval = null;
          this.lastPlayTime = 0;

          this.init();
        }

        init() {
          this.setupPlayer();
          this.bindEvents();
          this.createParticles();
          
          // Avvia keep-alive su mobile
          if (isMobile) {
            this.startKeepAlive();
          }
        }

        /* === HLS SETUP === */
        setupPlayer() {
          // Safari/iOS = HLS nativo
          if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
            console.log('[Player] Using native HLS');
            this.setupNativeHLS();
          } else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
            console.log('[Player] Using HLS.js');
            this.setupHlsJs();
          } else {
            this.showError('Browser non supportato');
          }
        }

        setupNativeHLS() {
          this.status('Connessione...');
          this.video.src = STREAM_URL;
          
          // Safari: ascolta loadedmetadata per sapere quando è pronto
          this.video.addEventListener('loadedmetadata', () => {
            this.status('Avvio...');
            this.play();
          }, { once: true });
        }

        setupHlsJs() {
          this.status('Connessione...');

          if (this.hls) {
            this.hls.destroy();
            this.hls = null;
          }

          this.hls = new Hls(HLS_CONFIG);

          // Manifest pronto = possiamo iniziare
          this.hls.on(Hls.Events.MANIFEST_PARSED, (e, data) => {
            console.log('[HLS] Manifest parsed, levels:', data.levels.length);
            this.status('Avvio...');
            this.play();
          });

          // Primo frammento bufferizzato
          this.hls.on(Hls.Events.FRAG_BUFFERED, () => {
            // Controlla se possiamo mostrare il video
            if (this.video.readyState >= 3) {
              this.setReady(true);
            }
          });

          // Errori
          this.hls.on(Hls.Events.ERROR, (e, data) => {
            console.warn('[HLS] Error:', data.type, data.details, data.fatal);
            
            if (data.fatal) {
              this.handleFatalError(data);
            } else {
              // Errori non fatali: HLS.js recupera da solo
              if (data.details === 'bufferStalledError') {
                this.status('Buffering...');
              }
            }
          });

          this.hls.loadSource(STREAM_URL);
          this.hls.attachMedia(this.video);
        }

        handleFatalError(data) {
          switch (data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              this.status('Riconnessione...');
              // Riprova a caricare
              setTimeout(() => {
                if (this.hls) {
                  this.hls.startLoad();
                }
              }, 1000);
              break;
              
            case Hls.ErrorTypes.MEDIA_ERROR:
              this.status('Recupero...');
              if (this.hls) {
                this.hls.recoverMediaError();
              }
              break;
              
            default:
              this.status('Errore');
              // Ricrea tutto il player
              setTimeout(() => this.setupPlayer(), 2000);
          }
        }

        play() {
          this.userPaused = false;
          this.lastPlayTime = Date.now();
          
          const playPromise = this.video.play();
          
          if (playPromise) {
            playPromise.then(() => {
              console.log('[Player] Playing');
              this.isPlaying = true;
            }).catch(err => {
              console.warn('[Player] Autoplay blocked:', err.message);
              this.status('Tap per avviare');
              this.showControls();
              this.setPaused(true);
            });
          }
        }

        status(t) {
          if (this.statusText) this.statusText.textContent = t;
        }

        showError(msg) {
          this.status(msg);
          this.wrapper.classList.add('is-offline');
        }

        /* === KEEP-ALIVE per Mobile === */
        startKeepAlive() {
          // Controlla ogni 2 secondi se il video è ancora in riproduzione
          this.keepAliveInterval = setInterval(() => {
            if (this.userPaused || document.hidden) return;
            
            // Se il video è in pausa ma non dovrebbe esserlo
            if (this.video.paused && this.isPlaying) {
              console.log('[KeepAlive] Video paused unexpectedly, resuming...');
              this.video.play().catch(() => {});
            }
            
            // Se il video è bloccato (currentTime non cambia)
            const now = Date.now();
            if (!this.video.paused && this.lastPlayTime > 0) {
              const timeSincePlay = now - this.lastPlayTime;
              
              // Se sono passati più di 5 secondi e readyState è basso
              if (timeSincePlay > 5000 && this.video.readyState < 3) {
                console.log('[KeepAlive] Video stalled, restarting...');
                this.restartStream();
              }
            }
          }, 2000);
        }

        restartStream() {
          this.setReady(false);
          this.status('Riconnessione...');
          
          if (this.hls) {
            this.hls.stopLoad();
            setTimeout(() => {
              if (this.hls) {
                this.hls.startLoad(-1); // -1 = live edge
                this.play();
              }
            }, 500);
          } else {
            // Native HLS
            this.video.load();
            this.play();
          }
        }

        /* === UI === */
        setReady(ready) {
          if (ready) {
            this.wrapper.classList.add('is-ready');
            this.wrapper.classList.remove('is-offline');
          } else {
            this.wrapper.classList.remove('is-ready');
          }
        }

        setPaused(paused) {
          this.wrapper.classList.toggle('is-paused', paused);
          this.isPlaying = !paused;
        }

        showControls() {
          this.wrapper.classList.add('controls-visible');
          clearTimeout(this.autoHideTimer);
          this.autoHideTimer = setTimeout(() => {
            if (!this.video.paused) {
              this.wrapper.classList.remove('controls-visible');
            }
          }, 4000);
        }

        toggleControls() {
          if (this.wrapper.classList.contains('controls-visible')) {
            this.wrapper.classList.remove('controls-visible');
            clearTimeout(this.autoHideTimer);
          } else {
            this.showControls();
          }
        }

        togglePlayPause() {
          if (this.video.paused) {
            this.userPaused = false;
            this.status('Ripresa...');
            this.play();
          } else {
            this.userPaused = true;
            this.video.pause();
          }
          this.showControls();
        }

        /* === Fullscreen === */
        toggleFullscreen() {
          this.fsCurtain?.classList.add('on');
          this.pageCurtain?.classList.add('on');

          if (document.fullscreenElement || document.webkitFullscreenElement) {
            (document.exitFullscreen || document.webkitExitFullscreen).call(document);
          } else {
            (this.wrapper.requestFullscreen || this.wrapper.webkitRequestFullscreen)?.call(this.wrapper);
          }
        }

        onFullscreenChange() {
          const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement);
          this.wrapper.classList.toggle('is-fullscreen', isFs);

          if (isFs) {
            screen.orientation?.lock?.('landscape').catch(() => {});
          } else {
            screen.orientation?.unlock?.();
          }

          setTimeout(() => {
            this.fsCurtain?.classList.remove('on');
            this.pageCurtain?.classList.remove('on');
          }, 200);
        }

        /* === Events === */
        bindEvents() {
          this.tapLayer?.addEventListener('click', () => this.toggleControls());
          
          this.osdBtn?.addEventListener('click', e => {
            e.stopPropagation();
            this.togglePlayPause();
          });

          this.fsBtn?.addEventListener('click', e => {
            e.stopPropagation();
            this.toggleFullscreen();
          });

          // === VIDEO EVENTS ===
          
          // canplay = ha abbastanza dati per iniziare
          this.video.addEventListener('canplay', () => {
            console.log('[Video] canplay');
            this.setReady(true);
          });

          // playing = sta effettivamente riproducendo
          this.video.addEventListener('playing', () => {
            console.log('[Video] playing');
            this.setPaused(false);
            this.setReady(true);
            this.lastPlayTime = Date.now();
          });

          // pause
          this.video.addEventListener('pause', () => {
            console.log('[Video] pause, userPaused:', this.userPaused);
            this.setPaused(true);
            
            // Se NON è stato l'utente a mettere in pausa, riprova
            if (!this.userPaused && !document.hidden) {
              setTimeout(() => {
                if (this.video.paused && !this.userPaused) {
                  console.log('[Video] Auto-resuming...');
                  this.play();
                }
              }, 300);
            } else {
              this.showControls();
            }
          });

          // waiting = buffering
          this.video.addEventListener('waiting', () => {
            console.log('[Video] waiting/buffering');
            // Non nascondere il video, solo log
          });

          // stalled = dati non arrivano
          this.video.addEventListener('stalled', () => {
            console.log('[Video] stalled');
          });

          // error
          this.video.addEventListener('error', (e) => {
            console.error('[Video] error:', e);
            this.setReady(false);
            this.status('Errore');
            
            // Riprova
            setTimeout(() => this.restartStream(), 2000);
          });

          // === VISIBILITY ===
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
              console.log('[Visibility] Tab visible');
              
              if (!this.userPaused) {
                // Tab tornata visibile: riprendi se necessario
                if (this.video.paused) {
                  this.play();
                }
                
                // Su mobile, ricrea lo stream per sicurezza
                if (isMobile) {
                  setTimeout(() => {
                    if (this.video.readyState < 3) {
                      this.restartStream();
                    }
                  }, 1000);
                }
              }
            }
          });

          // Online
          window.addEventListener('online', () => {
            console.log('[Network] Online');
            this.restartStream();
          });

          // Fullscreen
          document.addEventListener('fullscreenchange', () => this.onFullscreenChange());
          document.addEventListener('webkitfullscreenchange', () => this.onFullscreenChange());
        }

        /* === Particelle === */
        createParticles() {
          if (window.matchMedia?.('(prefers-reduced-motion: reduce)').matches) return;

          const container = $('particlesContainer');
          if (!container) return;

          const isMobileDevice = window.innerWidth < 769;
          const snowCount = isMobileDevice ? 25 : 45;
          const emberCount = isMobileDevice ? 10 : 20;

          const fragment = document.createDocumentFragment();
          
          for (let i = 0; i < snowCount; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            const size = Math.random() * 2.5 + 1.5;
            flake.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}vw;animation:fall ${Math.random()*6+6}s linear infinite ${Math.random()*-10}s`;
            fragment.appendChild(flake);
          }

          for (let i = 0; i < emberCount; i++) {
            const ember = document.createElement('div');
            ember.className = 'ember';
            const size = Math.random() * 3 + 2;
            ember.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}vw;animation:rise ${Math.random()*8+8}s linear infinite ${Math.random()*-15}s`;
            fragment.appendChild(ember);
          }

          container.appendChild(fragment);
        }
      }

      // Start
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => new LivePlayer());
      } else {
        new LivePlayer();
      }
    })();
  </script>
</body>
</html>
