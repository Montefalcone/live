<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-TileColor" content="#000000">
  
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <title>Webcam Montefalcone di Val Fortore</title>
  <meta name="description" content="Webcam in diretta dal Comune di Montefalcone. Vista panoramica e condizioni meteo attuali">
  <meta name="keywords" content="webcam montefalcone, meteo montefalcone, comune di montefalcone live, telecamera diretta">
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="DLjKDn5UupGNdRgZXo9CuMc0Sg1S1aULxDJfIHT9tYo">
  <link rel="canonical" href="https://www.webcammontefalconedivalfortore.it/">
  
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.webcammontefalconedivalfortore.it/">
  <meta property="og:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta property="og:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta property="og:image" content="https://www.webcammontefalconedivalfortore.it/p.png">
  <meta property="og:locale" content="it_IT">
  <meta property="og:site_name" content="Webcam Montefalcone">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta name="twitter:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta name="twitter:image" content="https://www.webcammontefalconedivalfortore.it/p.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://live.webcammontefalconedivalfortore.it" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  
  <!-- Preload HLS.js per caricamento più veloce -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js" as="script">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --blur-ui: 12px;
      --blur-play: 5px;
      --color-bg: #000;
      --color-live: #ff2b2b;
      --color-white: #fff;
      --color-overlay: rgba(0, 0, 0, 0.35);
      --color-border: rgba(255, 255, 255, 0.18);
      --radius-pill: 999px;
      --radius-video: 15px;
      --transition-fast: 150ms ease;
      --transition-medium: 260ms ease;
      --transition-slow: 500ms ease;
      --shadow-glow: 0 0 30px rgba(255, 220, 150, 0.2);
      --shadow-deep: 0 40px 80px rgba(0, 0, 0, 0.95);
      --shadow-button: 0 10px 28px rgba(0, 0, 0, 0.28);
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      overscroll-behavior: none;
      background-color: var(--color-bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    @font-face {
      font-family: 'MerryChristmasFont';
      src: url('last.otf') format('opentype');
      font-display: swap;
    }

    #main-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 20;
      transition: all var(--transition-slow);
    }

    @media (min-width: 1024px) {
      #main-container {
        transform: scale(0.965);
        transform-origin: center top;
      }
    }

    #bg-static {
      position: absolute;
      top: -10%;
      left: -10%;
      width: 120%;
      height: 120%;
      background-image: url("1a.webp");
      background-size: cover;
      background-position: center;
      z-index: 0;
      filter: brightness(0.65) contrast(1.15) saturate(1.1);
      animation: driftingWorld 80s ease-in-out infinite alternate;
      pointer-events: none;
      will-change: transform;
    }

    @keyframes driftingWorld {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-2%, 2%) scale(1.05); }
    }

    .municipality-logo,
    .festive-message,
    .warm-flicker,
    .vignette,
    .particles-container {
      transition: opacity var(--transition-slow);
      opacity: 1;
      pointer-events: none;
    }

    .municipality-logo {
      width: 110px;
      height: auto;
      margin-bottom: 15px;
      z-index: 30;
      filter: brightness(1.1) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
    }

    .festive-message {
      font-family: 'MerryChristmasFont', 'Brush Script MT', cursive, serif;
      color: var(--color-white);
      text-align: center;
      font-size: 3.5rem;
      line-height: 1.2;
      margin-bottom: 25px;
      text-shadow: 2px 2px 4px var(--color-bg), 0 0 25px rgba(255, 255, 255, 0.6);
      z-index: 30;
      padding: 0 20px;
      width: 100%;
    }

    .warm-flicker {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 180, 50, 0.15), transparent 80%);
      z-index: 2;
      pointer-events: none;
      mix-blend-mode: overlay;
      animation: firePulse 4s ease-in-out infinite alternate;
    }

    @keyframes firePulse {
      0% { opacity: 0.1; }
      100% { opacity: 0.5; }
    }

    .vignette {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.7) 85%, var(--color-bg) 100%);
      z-index: 6;
      pointer-events: none;
    }

    .particles-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      overflow: hidden;
    }

    .snowflake {
      position: absolute;
      top: -10px;
      background: white;
      border-radius: 50%;
      opacity: 0.9;
      box-shadow: 0 0 3px white;
      will-change: transform;
    }

    .ember {
      position: absolute;
      bottom: -20px;
      background: #ffcc00;
      border-radius: 50%;
      opacity: 0;
      filter: blur(2px);
      will-change: transform, opacity;
    }

    @keyframes fall {
      0% { transform: translate(0, -10vh); }
      100% { transform: translate(15vw, 110vh); }
    }

    @keyframes riseRight {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      20% { opacity: 0.8; }
      100% { transform: translateY(-90vh) translateX(15vw); opacity: 0; }
    }

    @keyframes riseLeft {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      20% { opacity: 0.8; }
      100% { transform: translateY(-90vh) translateX(-15vw); opacity: 0; }
    }

    @keyframes riseZigZag {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      25% { transform: translateY(-20vh) translateX(5vw); opacity: 0.8; }
      75% { transform: translateY(-60vh) translateX(-5vw); opacity: 0.4; }
      100% { transform: translateY(-90vh) translateX(0); opacity: 0; }
    }

    /* Video Player */
    .video-wrapper {
      position: relative;
      width: auto;
      height: 60%;
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-video);
      overflow: hidden;
      background: var(--color-bg);
      box-shadow: var(--shadow-glow), var(--shadow-deep);
      border: 1px solid var(--color-border);
      z-index: 30;
      pointer-events: auto;
      transition: all 0.3s ease-out;
    }

    .video-wrapper:fullscreen,
    .video-wrapper:-webkit-full-screen {
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      width: 100vw !important;
      height: 100vh !important;
    }

    #liveVideo {
      width: 100%;
      height: 100%;
      display: block;
      background: var(--color-bg);
      object-fit: contain;
    }

    .tap-layer {
      position: absolute;
      inset: 0;
      z-index: 10;
      cursor: default;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: absolute;
      inset: 0;
      z-index: 80;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--color-bg);
      opacity: 1;
      transition: opacity var(--transition-medium), visibility 0ms linear 0ms;
      pointer-events: none;
      visibility: visible;
    }

    .video-wrapper.is-ready .loading-overlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-medium), visibility 0ms linear 260ms;
    }

    .loading-overlay .preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.82) contrast(1.08);
      opacity: 0.85;
    }

    .loading-overlay .spinner-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .loading-overlay .spinner {
      width: 46px;
      height: 46px;
      border-radius: var(--radius-pill);
      border: 3px solid rgba(255, 255, 255, 0.25);
      border-top-color: rgba(255, 255, 255, 0.92);
      animation: spin 0.9s linear infinite;
      box-shadow: var(--shadow-button);
    }

    .loading-overlay .status-text {
      font-family: "Poppins", sans-serif;
      font-size: 11px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Control Bar */
    .control-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.75), transparent);
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .video-wrapper.controls-visible .control-bar {
      pointer-events: auto;
      opacity: 1;
    }

    /* Fullscreen Button */
    .fs-btn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.20);
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }

    .fs-btn:hover {
      transform: scale(1.05);
    }

    .fs-btn:active {
      transform: scale(0.95);
    }

    .fs-btn svg {
      width: 20px;
      height: 20px;
      fill: var(--color-white);
    }

    .fs-btn .icon-exit { display: none; }
    .video-wrapper.is-fullscreen .fs-btn .icon-enter { display: none; }
    .video-wrapper.is-fullscreen .fs-btn .icon-exit { display: block; }

    /* Live Badge */
    .live-badge {
      position: absolute;
      left: 14px;
      bottom: 14px;
      z-index: 31;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-pill);
      color: var(--color-white);
      font-family: "Poppins", sans-serif;
      font-weight: 700;
      font-size: 12px;
      line-height: 1;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.18);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-button);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      pointer-events: none;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-live);
      box-shadow: 0 0 12px rgba(255, 43, 43, 0.95);
      animation: livePulse 1.6s infinite;
    }

    /* Stato offline/errore */
    .video-wrapper.is-offline .live-dot {
      background: #888;
      box-shadow: none;
      animation: none;
    }

    @keyframes livePulse {
      0% { opacity: 1; }
      50% { opacity: 0.45; }
      100% { opacity: 1; }
    }

    /* OSD Play/Pause */
    .osd {
      position: absolute;
      inset: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .osd-chip {
      position: relative;
      width: 84px;
      height: 84px;
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      padding: 0;
      margin: 0;
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.22);
      backdrop-filter: blur(var(--blur-play)) brightness(1.05) saturate(1.1);
      -webkit-backdrop-filter: blur(var(--blur-play)) brightness(1.05) saturate(1.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 140ms ease, transform 140ms ease;
      pointer-events: none;
    }

    .video-wrapper.controls-visible .osd-chip {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    .osd-chip:hover {
      transform: scale(1.05);
    }

    .osd-chip:active {
      transform: scale(0.95);
    }

    .osd-icon {
      width: 40px;
      height: 40px;
      fill: var(--color-white);
      opacity: 0.95;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .osd-icon.play { display: none; }
    .video-wrapper.is-paused .osd-icon.play { display: block; }
    .video-wrapper.is-paused .osd-icon.pause { display: none; }

    /* Curtains */
    #pageCurtain,
    .fs-curtain {
      background: var(--color-bg);
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
      will-change: opacity;
    }

    #pageCurtain {
      position: fixed;
      inset: 0;
      z-index: 9999;
    }

    .fs-curtain {
      position: absolute;
      inset: 0;
      z-index: 200;
      border-radius: inherit;
    }

    #pageCurtain.on,
    .fs-curtain.on {
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 768px) and (orientation: portrait) {
      #main-container {
        justify-content: flex-start;
        padding-top: 18vh;
      }

      .municipality-logo {
        width: 75px;
        margin-bottom: 10px;
      }

      .festive-message {
        font-size: 6vw;
        line-height: 1.4;
        margin-bottom: 20px;
      }

      .video-wrapper {
        width: 95%;
        height: auto;
      }

      #bg-static {
        animation: driftingWorldMobile 35s ease-in-out infinite alternate;
      }

      .osd-chip {
        width: 68px;
        height: 68px;
      }

      .osd-icon {
        width: 32px;
        height: 32px;
      }

      .fs-btn {
        width: 38px;
        height: 38px;
      }

      .live-badge {
        padding: 6px 10px;
        font-size: 10px;
        gap: 6px;
      }

      .live-dot {
        width: 6px;
        height: 6px;
      }
    }

    @keyframes driftingWorldMobile {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-3%, 0) scale(1.15); }
    }

    @media screen and (orientation: landscape) and (max-height: 600px) {
      .municipality-logo,
      .festive-message,
      #bg-static,
      .warm-flicker,
      .vignette,
      .particles-container {
        display: none !important;
      }

      #main-container {
        padding: 0 !important;
        justify-content: center !important;
        background: var(--color-bg);
      }

      .video-wrapper {
        width: 100vw;
        height: 100vh;
        border: none;
        border-radius: 0;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }

      .particles-container {
        display: none !important;
      }

      .loading-overlay .spinner {
        animation: spin 0.9s linear infinite !important;
      }
    }
  </style>
</head>

<body>
  <div id="bg-static"></div>
  <div class="warm-flicker"></div>
  <div class="vignette"></div>
  <div class="particles-container" id="particlesContainer"></div>

  <div id="main-container">
    <img 
      src="stemma2-removebg-preview.png" 
      alt="Stemma Comune di Montefalcone di Val Fortore" 
      class="municipality-logo"
      width="110"
      height="110"
      loading="eager"
    >

    <div class="festive-message">
      Il comune di Montefalcone di Val Fortore<br>
      augura a tutti Buone Feste
    </div>

    <div class="video-wrapper" id="videoWrapper">
      <video
        id="liveVideo"
        playsinline
        muted
        preload="auto"
      ></video>

      <div class="loading-overlay" id="loadingOverlay">
        <img 
          class="preview" 
          src="https://www.webcammontefalconedivalfortore.it/p.png" 
          alt=""
          loading="eager"
        >
        <div class="spinner-container">
          <div class="spinner"></div>
          <div class="status-text" id="statusText">Connessione...</div>
        </div>
      </div>

      <div class="tap-layer" id="tapLayer"></div>

      <div class="live-badge">
        <span class="live-dot"></span>
        <span>LIVE</span>
      </div>

      <div class="osd">
        <button class="osd-chip" id="osdBtn" type="button" aria-label="Play/Pausa">
          <svg class="osd-icon play" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg class="osd-icon pause" viewBox="0 0 24 24">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
      </div>

      <div class="control-bar">
        <button class="fs-btn" id="fsBtn" type="button" aria-label="Schermo intero">
          <svg class="icon-enter" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
          <svg class="icon-exit" viewBox="0 0 24 24">
            <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
          </svg>
        </button>
      </div>

      <div class="fs-curtain" id="fsCurtain"></div>
    </div>
  </div>

  <div id="pageCurtain"></div>

  <!-- HLS.js - Versione stabile -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>

  <script>
    (() => {
      'use strict';

      /* =====================================================
         CONFIGURAZIONE HLS.js OTTIMIZZATA PER LIVE
         ===================================================== */
      const HLS_CONFIG = {
        // === LIVE SYNC ===
        // Questi parametri gestiscono AUTOMATICAMENTE la sincronizzazione live
        // Niente più seek manuali!
        liveSyncDuration: 3,           // Stai 3 secondi dietro al live edge
        liveMaxLatencyDuration: 8,     // Se superi 8 sec, HLS.js fa catch-up automatico
        liveDurationInfinity: true,    // Stream infinito (live)
        
        // === BUFFERING OTTIMIZZATO ===
        maxBufferLength: 10,           // Max 10 sec di buffer (riduce memoria)
        maxMaxBufferLength: 20,        // Hard limit buffer
        maxBufferSize: 30 * 1000000,   // 30MB max buffer size
        maxBufferHole: 0.5,            // Tolleranza buchi nel buffer
        
        // === STARTUP VELOCE ===
        startLevel: -1,                // Auto-detect qualità iniziale
        autoStartLoad: true,           // Inizia subito a caricare
        startPosition: -1,             // Parti dal live edge
        
        // === LATENZA BASSA ===
        lowLatencyMode: true,          // Modalità bassa latenza
        backBufferLength: 0,           // Non tenere buffer passato (risparmia RAM)
        
        // === RECOVERY ERRORI ===
        manifestLoadingTimeOut: 8000,  // 8 sec timeout manifest
        manifestLoadingMaxRetry: 4,    // 4 tentativi manifest
        levelLoadingTimeOut: 8000,     // 8 sec timeout levels
        levelLoadingMaxRetry: 4,       // 4 tentativi levels
        fragLoadingTimeOut: 15000,     // 15 sec timeout frammenti
        fragLoadingMaxRetry: 6,        // 6 tentativi frammenti
        
        // === PERFORMANCE ===
        enableWorker: true,            // Usa Web Worker (performance)
        testBandwidth: true,           // Testa banda per ABR
      };

      const STREAM_URL = 'https://live.webcammontefalconedivalfortore.it/memfs/58e0bcbe-f1bd-4c8b-85f7-b4566a3e5392.m3u8';

      const UI_CONFIG = {
        AUTOHIDE_MS: 4000,
        READY_DELAY_MS: 300,
      };

      /* =====================================================
         UTILITIES
         ===================================================== */
      const $ = id => document.getElementById(id);
      const isTouchDevice = () => 'ontouchstart' in window || navigator.maxTouchPoints > 0;

      /* =====================================================
         PLAYER CLASS
         ===================================================== */
      class LivePlayer {
        constructor() {
          // Elementi DOM
          this.wrapper = $('videoWrapper');
          this.video = $('liveVideo');
          this.tapLayer = $('tapLayer');
          this.osdBtn = $('osdBtn');
          this.fsBtn = $('fsBtn');
          this.fsCurtain = $('fsCurtain');
          this.pageCurtain = $('pageCurtain');
          this.statusText = $('statusText');

          // Stato
          this.hls = null;
          this.autoHideTimer = null;
          this.isTouch = isTouchDevice();
          this.retryCount = 0;
          this.maxRetries = 5;

          this.init();
        }

        init() {
          this.setupPlayer();
          this.bindEvents();
          this.createParticles();
          this.hideControls();
        }

        /* =====================================================
           SETUP PLAYER HLS.js
           ===================================================== */
        setupPlayer() {
          // Safari supporta HLS nativamente
          if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
            this.setupNativeHLS();
          } else if (Hls.isSupported()) {
            this.setupHlsJs();
          } else {
            this.showError('Browser non supportato');
          }
        }

        setupNativeHLS() {
          // Safari - usa HLS nativo
          this.updateStatus('Connessione...');
          this.video.src = STREAM_URL;
          
          this.video.addEventListener('loadedmetadata', () => {
            this.updateStatus('Avvio...');
            this.startPlayback();
          });

          this.video.addEventListener('error', () => {
            this.handlePlaybackError('Errore stream');
          });
        }

        setupHlsJs() {
          this.updateStatus('Inizializzazione...');

          // Crea istanza HLS con config ottimizzata
          this.hls = new Hls(HLS_CONFIG);

          // === EVENT HANDLERS ===
          
          // Manifest caricato
          this.hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
            console.log(`[HLS] Manifest parsed, ${data.levels.length} quality levels`);
            this.updateStatus('Avvio stream...');
            this.startPlayback();
          });

          // Primo frammento caricato
          this.hls.on(Hls.Events.FRAG_LOADED, () => {
            if (!this.wrapper.classList.contains('is-ready')) {
              this.updateStatus('Buffering...');
            }
          });

          // Cambio livello qualità (ABR)
          this.hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
            console.log(`[HLS] Quality: ${this.hls.levels[data.level]?.height || 'auto'}p`);
          });

          // Recupero da ritardo live (catch-up automatico)
          this.hls.on(Hls.Events.LIVE_BACK_BUFFER_REACHED, () => {
            console.log('[HLS] Live sync: catching up to live edge');
          });

          // Errori
          this.hls.on(Hls.Events.ERROR, (event, data) => {
            this.handleHlsError(data);
          });

          // Collega al video element
          this.hls.loadSource(STREAM_URL);
          this.hls.attachMedia(this.video);
        }

        handleHlsError(data) {
          console.warn('[HLS] Error:', data.type, data.details);

          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                this.updateStatus('Errore rete...');
                console.log('[HLS] Network error, attempting recovery...');
                this.hls.startLoad();
                break;

              case Hls.ErrorTypes.MEDIA_ERROR:
                this.updateStatus('Errore media...');
                console.log('[HLS] Media error, attempting recovery...');
                this.hls.recoverMediaError();
                break;

              default:
                this.handlePlaybackError('Errore fatale');
                break;
            }
          }
        }

        startPlayback() {
          const playPromise = this.video.play();

          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                console.log('[Player] Playback started');
              })
              .catch(err => {
                console.warn('[Player] Autoplay blocked:', err.message);
                this.updateStatus('Tap per avviare');
                this.showControls();
                this.setPausedUI(true);
              });
          }
        }

        handlePlaybackError(message) {
          console.error('[Player] Error:', message);
          this.retryCount++;

          if (this.retryCount <= this.maxRetries) {
            this.updateStatus(`Riconnessione (${this.retryCount}/${this.maxRetries})...`);
            
            setTimeout(() => {
              if (this.hls) {
                this.hls.destroy();
              }
              this.setupPlayer();
            }, 2000 * this.retryCount); // Backoff esponenziale
          } else {
            this.updateStatus('Stream non disponibile');
            this.wrapper.classList.add('is-offline');
          }
        }

        showError(message) {
          this.updateStatus(message);
          this.wrapper.classList.add('is-offline');
        }

        updateStatus(text) {
          if (this.statusText) {
            this.statusText.textContent = text;
          }
        }

        /* =====================================================
           UI CONTROLS
           ===================================================== */
        setReady(ready) {
          this.wrapper.classList.toggle('is-ready', ready);
          if (ready) {
            this.retryCount = 0;
            this.wrapper.classList.remove('is-offline');
          }
        }

        setPausedUI(paused) {
          this.wrapper.classList.toggle('is-paused', paused);
          this.osdBtn?.setAttribute('aria-label', paused ? 'Play' : 'Pausa');
        }

        showControls() {
          this.wrapper.classList.add('controls-visible');
          this.scheduleAutoHide();
        }

        hideControls() {
          this.wrapper.classList.remove('controls-visible');
          this.clearAutoHide();
        }

        toggleControls() {
          if (this.wrapper.classList.contains('controls-visible')) {
            this.hideControls();
          } else {
            this.showControls();
          }
        }

        clearAutoHide() {
          if (this.autoHideTimer) {
            clearTimeout(this.autoHideTimer);
            this.autoHideTimer = null;
          }
        }

        scheduleAutoHide() {
          this.clearAutoHide();
          this.autoHideTimer = setTimeout(() => {
            if (!this.video.paused) {
              this.hideControls();
            }
          }, UI_CONFIG.AUTOHIDE_MS);
        }

        bumpAutoHide() {
          if (this.wrapper.classList.contains('controls-visible')) {
            this.scheduleAutoHide();
          }
        }

        togglePlayPause() {
          if (this.video.paused) {
            this.setReady(false);
            this.updateStatus('Ripresa...');
            this.video.play().catch(() => {});
          } else {
            this.video.pause();
          }
          this.showControls();
        }

        /* =====================================================
           FULLSCREEN
           ===================================================== */
        toggleFullscreen() {
          if (this.isTouch) {
            this.fsCurtain?.classList.add('on');
            this.pageCurtain?.classList.add('on');
          }

          if (document.fullscreenElement || document.webkitFullscreenElement) {
            (document.exitFullscreen || document.webkitExitFullscreen).call(document);
          } else {
            const requestFs = this.wrapper.requestFullscreen || this.wrapper.webkitRequestFullscreen;
            requestFs?.call(this.wrapper);
          }
        }

        onFullscreenChange() {
          const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement);
          this.wrapper.classList.toggle('is-fullscreen', isFs);

          if (this.isTouch) {
            if (isFs) {
              this.lockOrientation('landscape');
            } else {
              this.unlockOrientation();
            }

            setTimeout(() => {
              this.fsCurtain?.classList.remove('on');
              this.pageCurtain?.classList.remove('on');
            }, 220);
          }
        }

        async lockOrientation(mode) {
          try {
            await screen.orientation?.lock?.(mode);
          } catch (e) {}
        }

        unlockOrientation() {
          try {
            screen.orientation?.unlock?.();
          } catch (e) {}
        }

        /* =====================================================
           EVENT BINDING
           ===================================================== */
        bindEvents() {
          // Tap layer
          this.tapLayer?.addEventListener('click', () => this.toggleControls());

          // Movimento = mostra controlli
          ['pointermove', 'touchstart'].forEach(evt => {
            this.wrapper.addEventListener(evt, () => this.bumpAutoHide(), { passive: true });
          });

          // Play/Pause button
          this.osdBtn?.addEventListener('click', e => {
            e.stopPropagation();
            this.togglePlayPause();
          });

          // Fullscreen button
          this.fsBtn?.addEventListener('click', e => {
            e.stopPropagation();
            this.toggleFullscreen();
          });

          // Video events
          this.video.addEventListener('playing', () => {
            this.setPausedUI(false);
            setTimeout(() => this.setReady(true), UI_CONFIG.READY_DELAY_MS);
          });

          this.video.addEventListener('pause', () => {
            this.setPausedUI(true);
            this.showControls();
          });

          this.video.addEventListener('waiting', () => {
            // Buffering - HLS.js gestisce automaticamente
            console.log('[Player] Buffering...');
          });

          this.video.addEventListener('stalled', () => {
            console.log('[Player] Stalled, waiting for data...');
          });

          // Visibility change - riconnetti se necessario
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && !this.video.paused) {
              // HLS.js gestisce automaticamente il catch-up
              // Niente da fare qui!
              console.log('[Player] Tab visible, HLS.js will sync automatically');
            }
          });

          // Online/Offline
          window.addEventListener('online', () => {
            console.log('[Player] Back online');
            if (this.hls) {
              this.hls.startLoad();
            }
          });

          // Fullscreen change
          document.addEventListener('fullscreenchange', () => this.onFullscreenChange());
          document.addEventListener('webkitfullscreenchange', () => this.onFullscreenChange());
        }

        /* =====================================================
           PARTICELLE
           ===================================================== */
        createParticles() {
          if (window.matchMedia?.('(prefers-reduced-motion: reduce)').matches) {
            return;
          }

          const container = $('particlesContainer');
          if (!container) return;

          const isMobile = window.innerWidth < 768;
          const snowCount = isMobile ? 35 : 70;
          const emberCount = isMobile ? 15 : 30;
          const speedMod = isMobile ? 1.5 : 1;

          const fragment = document.createDocumentFragment();

          // Neve
          for (let i = 0; i < snowCount; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            const size = Math.random() * 3 + 2;
            flake.style.cssText = `
              width: ${size}px;
              height: ${size}px;
              left: ${Math.random() * 120 - 10}vw;
              animation: fall ${(Math.random() * 4 + 4) * speedMod}s linear infinite;
              animation-delay: -${Math.random() * 5}s;
            `;
            fragment.appendChild(flake);
          }

          // Embers
          const anims = ['riseRight', 'riseLeft', 'riseZigZag'];
          for (let i = 0; i < emberCount; i++) {
            const ember = document.createElement('div');
            ember.className = 'ember';
            const size = Math.random() * 4 + 3;
            ember.style.cssText = `
              width: ${size}px;
              height: ${size}px;
              left: ${Math.random() * 100}vw;
              animation: ${anims[Math.floor(Math.random() * 3)]} ${(Math.random() * 6 + 6) * speedMod}s linear infinite;
              animation-delay: -${Math.random() * 10}s;
            `;
            fragment.appendChild(ember);
          }

          container.appendChild(fragment);
        }
      }

      /* =====================================================
         INIT
         ===================================================== */
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => new LivePlayer());
      } else {
        new LivePlayer();
      }
    })();
  </script>
</body>
</html>
