<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="google-site-verification" content="DLjKDn5UupGNdRgZXo9CuMc0Sg1S1aULxDJfIHT9tYo" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <title>Webcam Montefalcone di Val Fortore - LIVE</title>

  <meta name="description" content="Guarda la webcam in diretta dal Comune di Montefalcone. Vista panoramica live, condizioni meteo attuali e immagini in tempo reale dal centro storico.">
  <meta name="keywords" content="webcam montefalcone, meteo montefalcone, comune di montefalcone live, telecamera diretta">
  <meta property="og:title" content="Webcam Montefalcone Live">
  <meta property="og:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta property="og:image" content="https://www.webcammontefalconedivalfortore.it/p.png">
  <meta name="robots" content="index, follow">

  <script type="module" src="https://cdn.jsdelivr.net/npm/media-chrome@4/+esm"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/hls-video-element@1/+esm"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ui-blur: 4px;       /* blur fullscreen + badge */
      --ui-bg: rgba(0,0,0,.35);
      --ui-border: rgba(255,255,255,.20);
    }

    /* Desktop: rimpicciolisci leggermente tutto per non dare fastidio con taskbar */
    @media (min-width: 1024px) {
      #main-container{
        transform: scale(0.965);
        transform-origin: center top;
      }
    }

    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      position: fixed;
      top: 0; left: 0;
      overscroll-behavior: none;
      touch-action: none; /* blocca gesture/zoom */
      background-color: #000;
    }

    @font-face {
      font-family: 'MerryChristmasFont';
      src: url('last.otf') format('opentype');
      font-display: swap;
    }

    #main-container {
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      position: relative; z-index: 20;
      transition: all 0.5s ease;
    }

    #bg-static {
      position: absolute;
      top: -10%; left: -10%; width: 120%; height: 120%;
      background-image: url("1a.webp");
      background-size: cover; background-position: center;
      z-index: 0;
      filter: brightness(0.65) contrast(1.15) saturate(1.1);
      animation: driftingWorld 80s ease-in-out infinite alternate;
      pointer-events: none;
    }
    @keyframes driftingWorld {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-2%, 2%) scale(1.05); }
    }

    .municipality-logo, .festive-message, .warm-flicker, .vignette, .particles-container {
      transition: opacity 0.5s ease;
      opacity: 1;
      pointer-events: none;
    }

    .municipality-logo {
      width: 110px; height: auto;
      margin-bottom: 15px; z-index: 30;
      filter: brightness(1.1) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
    }

    .festive-message {
      font-family: 'MerryChristmasFont', serif;
      color: #ffffff; text-align: center;
      font-size: 3.5rem; line-height: 1.2; margin-bottom: 25px;
      text-shadow: 2px 2px 4px #000, 0 0 25px rgba(255, 255, 255, 0.6);
      z-index: 30; padding: 0 20px; width: 100%; box-sizing: border-box;
    }

    .video-wrapper {
      position: relative;
      width: auto; height: 60%;
      aspect-ratio: 16/9;
      border-radius: 15px; overflow: hidden; background: #000;
      box-shadow: 0 0 30px rgba(255, 220, 150, 0.2), 0 40px 80px rgba(0,0,0,0.95);
      border: 1px solid rgba(255, 255, 255, 0.15); z-index: 30;
      pointer-events: auto;
      transition: all 0.3s ease-out;
      will-change: width, height;
    }

    .video-wrapper:fullscreen,
    .video-wrapper:-webkit-full-screen,
    .video-wrapper:-moz-full-screen {
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      width: 100% !important;
      height: 100% !important;
    }

    #videoWrapper media-controller {
      width: 100%; height: 100%;
      display: block; position: relative;
      background: #000;
      --media-tooltip-display: none; /* no tooltip "Enter Fullscreen" */
    }

    #videoWrapper hls-video {
      width: 100%; height: 100%;
      display: block; background: #000;
      object-fit: contain;
    }

    #videoWrapper .tap-layer {
      position: absolute; inset: 0; z-index: 10;
      cursor: default;
    }

    /* Loading overlay */
    #videoWrapper .loading-overlay{
      position:absolute; inset:0;
      z-index: 80;
      display:flex; align-items:center; justify-content:center;
      background:#000;
      opacity:1;
      transition: opacity 260ms ease;
      pointer-events:none;
    }
    #videoWrapper.is-ready .loading-overlay{ opacity:0; }

    #videoWrapper .loading-overlay .preview{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter: brightness(.82) contrast(1.08);
      opacity:.85;
    }

    #videoWrapper .loading-overlay .spinner{
      position:relative;
      width:46px; height:46px;
      border-radius:999px;
      border:3px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.92);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      transform: translateZ(0) rotate(0deg);
      -webkit-transform: translateZ(0) rotate(0deg);
      will-change: transform;
    }
    @keyframes spin {
      from { transform: translateZ(0) rotate(0deg); }
      to   { transform: translateZ(0) rotate(360deg); }
    }

    /* Control bar */
    #videoWrapper media-control-bar {
      position: absolute; left: 0; right: 0; bottom: 0;
      z-index: 30;
      padding: 12px 12px;
      display: flex; align-items: center; justify-content: flex-end;
      gap: 10px;
      background: linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,0));
      transition: opacity 180ms ease;
      opacity: 0;
      pointer-events: none;
    }
    #videoWrapper.controls-visible media-control-bar {
      opacity: 1;
      pointer-events: auto;
    }

    /* Fullscreen button */
    #videoWrapper media-fullscreen-button {
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 1px solid var(--ui-border);
      background: var(--ui-bg);

      backdrop-filter: blur(var(--ui-blur));
      -webkit-backdrop-filter: blur(var(--ui-blur));

      cursor: pointer;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: backdrop-filter, transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    /* LIVE badge */
    #videoWrapper .live-badge {
      position: absolute; left: 14px; bottom: 14px; z-index: 31;
      display: inline-flex; align-items: center; gap: 8px;

      padding: 8px 12px;
      border-radius: 999px;

      color: #fff;
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 700;
      font-size: 12px;
      line-height: 1;
      letter-spacing: .14em;
      text-transform: uppercase;

      background: rgba(0, 0, 0, 0.18);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 28px rgba(0,0,0,.28);

      backdrop-filter: blur(var(--ui-blur));
      -webkit-backdrop-filter: blur(var(--ui-blur));
      pointer-events: none;

      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: backdrop-filter, transform;
    }

    #videoWrapper .live-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #ff2b2b;
      box-shadow: 0 0 12px rgba(255, 43, 43, .95);
      animation: livePulse 1.6s infinite;
    }
    @keyframes livePulse { 0%{opacity:1} 50%{opacity:.45} 100%{opacity:1} }

    /* OSD */
    #videoWrapper .osd {
      position: absolute; inset: 0; z-index: 20;
      display: flex; align-items: center; justify-content: center;
      pointer-events: none;
      opacity: 0;
      transform: translateZ(0) scale(.98);
      -webkit-transform: translateZ(0) scale(.98);
      transition: opacity 140ms ease, transform 140ms ease;
      will-change: opacity, transform;
    }

    /* ✅ FIX BLUR TASTO PLAY
       Aumentato il blur a 30px e ridotta l'opacità dello sfondo.
       Forzata accelerazione hardware per renderizzare sopra il video.
    */
    #videoWrapper .osd-chip {
      width: 84px; height: 84px; border-radius: 999px;
      display: flex; align-items: center; justify-content: center;

      background: rgba(10, 10, 10, 0.20); /* Sfondo molto trasparente */
      border: 1px solid rgba(255,255,255,.25);

      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);

      pointer-events: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      padding: 0;
      margin: 0;

      /* FORZA RENDERING SU GPU */
      transform: translate3d(0,0,0);
      -webkit-transform: translate3d(0,0,0);
      will-change: backdrop-filter, transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    #videoWrapper.controls-visible .osd {
      opacity: 1;
      transform: translateZ(0) scale(1);
      -webkit-transform: translateZ(0) scale(1);
    }
    #videoWrapper.controls-visible .osd-chip { pointer-events: auto; }

    #videoWrapper .osd-icon { width: 40px; height: 40px; fill: #fff; opacity: .95; }
    #videoWrapper .osd-icon.play { display: none; }
    #videoWrapper.is-paused .osd-icon.play { display: block; }
    #videoWrapper.is-paused .osd-icon.pause { display: none; }

    /* PREWARM: renderizza blur per 1 frame senza mostrarlo */
    #videoWrapper.prewarm media-control-bar,
    #videoWrapper.prewarm .osd {
      opacity: 0.001 !important;
      transition: none !important;
      pointer-events: none !important;
    }

    /* effetti */
    .warm-flicker { position: absolute; inset: 0; background: radial-gradient(circle, rgba(255, 180, 50, 0.15), transparent 80%); z-index: 2; pointer-events: none; mix-blend-mode: overlay; animation: firePulse 4s ease-in-out infinite alternate; }
    @keyframes firePulse { 0% { opacity: 0.1; } 100% { opacity: 0.5; } }
    .particles-container { position: absolute; inset: 0; pointer-events: none; z-index: 5; overflow: hidden; }
    .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.9; box-shadow: 0 0 3px white; }
    .ember { position: absolute; bottom: -20px; background: #ffcc00; border-radius: 50%; opacity: 0; filter: blur(2px); }
    .vignette { position: absolute; inset: 0; background: radial-gradient(circle at center, transparent 40%, rgba(0,0,0,0.7) 85%, black 100%); z-index: 6; pointer-events: none; }

    @keyframes fall { 0% { transform: translate(0, -10vh); } 100% { transform: translate(15vw, 110vh); } }
    @keyframes riseRight { 0% { transform: translateY(0) translateX(0); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(-90vh) translateX(15vw); opacity: 0; } }
    @keyframes riseLeft { 0% { transform: translateY(0) translateX(0); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(-90vh) translateX(-15vw); opacity: 0; } }
    @keyframes riseZigZag { 0% { transform: translateY(0) translateX(0); opacity: 0; } 25% { transform: translateY(-20vh) translateX(5vw); opacity: 0.8; } 75% { transform: translateY(-60vh) translateX(-5vw); opacity: 0.4; } 100% { transform: translateY(-90vh) translateX(0); opacity: 0; } }

    @media (max-width: 768px) and (orientation: portrait) {
      #main-container { justify-content: flex-start; padding-top: 18vh; }
      .municipality-logo { width: 75px; margin-bottom: 10px; }
      .festive-message { font-size: 6vw; line-height: 1.4; margin-bottom: 20px; }
      .video-wrapper { width: 95%; height: auto; }
      #bg-static { animation: driftingWorldMobile 35s ease-in-out infinite alternate; }
    }
    @keyframes driftingWorldMobile { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(-3%, 0) scale(1.15); } }

    @media screen and (orientation: landscape) and (max-height: 600px) {
      .municipality-logo, .festive-message, #bg-static, .warm-flicker, .vignette, .particles-container { display: none !important; }
      #main-container { padding: 0 !important; justify-content: center !important; background: #000; }
      .video-wrapper { width: 100vw; height: 100vh; border: none; border-radius: 0; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
      .particles-container { display: none !important; }
      #videoWrapper .loading-overlay .spinner{ animation: spin .9s linear infinite !important; }
    }
  </style>
</head>

<body>
  <div id="bg-static"></div>
  <div class="warm-flicker"></div>
  <div class="vignette"></div>
  <div class="particles-container" id="particlesContainer"></div>

  <div id="main-container">
    <img src="stemma2-removebg-preview.png" alt="Stemma Comune di Montefalcone" class="municipality-logo">

    <div class="festive-message">
      Il comune di Montefalcone di Val Fortore<br>
      augura a tutti Buone Feste
    </div>

    <div class="video-wrapper" id="videoWrapper">
      <media-controller id="mc" autohide="-1" gesturesdisabled fullscreenelement="videoWrapper">
        <hls-video
          id="liveVideo"
          slot="media"
          src="https://live.webcammontefalconedivalfortore.it/memfs/58e0bcbe-f1bd-4c8b-85f7-b4566a3e5392.m3u8"
          autoplay
          muted
          playsinline
          preload="auto"
          crossorigin="anonymous">
        </hls-video>

        <div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
          <img class="preview" src="https://www.webcammontefalconedivalfortore.it/p.png" alt="">
          <div class="spinner"></div>
        </div>

        <div class="tap-layer" id="tapLayer" aria-hidden="true"></div>

        <div class="live-badge" aria-hidden="true">
          <span class="live-dot"></span>
          <span>LIVE</span>
        </div>

        <div class="osd" aria-hidden="true">
          <button class="osd-chip" id="osdBtn" type="button" aria-label="Play/Pausa">
            <svg class="osd-icon play" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"></path></svg>
            <svg class="osd-icon pause" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
          </button>
        </div>

        <media-control-bar>
          <media-fullscreen-button id="fsBtn" notooltip tooltipplacement="none"></media-fullscreen-button>
        </media-control-bar>
      </media-controller>
    </div>
  </div>

  <script type="module">
    (async () => {
      const when = (tag) => {
        try { return customElements.whenDefined(tag); }
        catch { return Promise.resolve(); }
      };
      await Promise.all([when('media-controller'), when('media-fullscreen-button'), when('hls-video')]);

      const wrapper = document.getElementById('videoWrapper');
      const hlsEl   = document.getElementById('liveVideo');
      const tapLayer= document.getElementById('tapLayer');
      const osdBtn  = document.getElementById('osdBtn');

      if (!wrapper || !hlsEl) return;

      // --- blocco zoom "professionale" anche su desktop (Ctrl+wheel) + iOS gesture
      document.addEventListener('wheel', (e) => {
        if (e.ctrlKey) e.preventDefault();
      }, { passive: false });
      ['gesturestart','gesturechange','gestureend'].forEach(evt => {
        document.addEventListener(evt, (e) => e.preventDefault(), { passive: false });
      });

      // =========================================================================
      // FIX CRITICO BLUR: forza il video a non usare l'overlay hardware
      // applicando opacity 0.999 al tag <video> interno allo Shadow DOM.
      // Esegue il controllo in loop per assicurarsi che venga applicato.
      // =========================================================================
      function applyVideoOverlayFix() {
        if (!hlsEl || !hlsEl.shadowRoot) return;
        const v = hlsEl.shadowRoot.querySelector('video');
        if (v) {
          // Se non è già settato, applica l'hack
          if (v.style.opacity !== '0.999') {
            v.style.opacity = '0.999'; 
            v.style.transform = 'translateZ(0)';
            v.style.webkitTransform = 'translateZ(0)';
            v.style.willChange = 'opacity, transform';
            // console.log('FIX BLUR APPLICATO'); // Debug
          }
        }
      }

      // 1. Prova subito
      applyVideoOverlayFix();

      // 2. Riprova con un timer (polling) per i primi secondi
      const fixInterval = setInterval(applyVideoOverlayFix, 500);
      setTimeout(() => clearInterval(fixInterval), 8000); // Smette dopo 8 sec

      // 3. Osserva se il DOM cambia (es. il player ricarica il video)
      try {
        const observer = new MutationObserver(() => applyVideoOverlayFix());
        // Attendi che lo shadowRoot esista
        const waitForShadow = setInterval(() => {
          if (hlsEl.shadowRoot) {
            clearInterval(waitForShadow);
            applyVideoOverlayFix();
            observer.observe(hlsEl.shadowRoot, { childList: true, subtree: true });
          }
        }, 100);
      } catch(e){}
      // =========================================================================


      // stato video (usa l'elemento video interno se disponibile)
      function getInnerVideo() {
        try {
          const root = hlsEl.shadowRoot;
          const v = root?.querySelector('video');
          return v || null;
        } catch { return null; }
      }

      function setReady(ready) { wrapper.classList.toggle('is-ready', !!ready); }

      // click 1/2 + autohide
      const AUTOHIDE_MS = 4000;
      let autoHideTimer = null;

      function clearAutoHide(){ if (autoHideTimer) clearTimeout(autoHideTimer); autoHideTimer=null; }
      function scheduleAutoHide(){
        clearAutoHide();
        autoHideTimer = setTimeout(() => wrapper.classList.remove('controls-visible'), AUTOHIDE_MS);
      }
      function showControls(){ wrapper.classList.add('controls-visible'); scheduleAutoHide(); }
      function hideControls(){ wrapper.classList.remove('controls-visible'); clearAutoHide(); }
      function toggleControls(){ wrapper.classList.contains('controls-visible') ? hideControls() : showControls(); }
      function bumpControlsTimer(){ if (wrapper.classList.contains('controls-visible')) scheduleAutoHide(); }

      tapLayer?.addEventListener('click', toggleControls);
      wrapper.addEventListener('pointermove', bumpControlsTimer, { passive:true });
      wrapper.addEventListener('touchstart', bumpControlsTimer, { passive:true });
      wrapper.addEventListener('mousemove', bumpControlsTimer, { passive:true });

      // play/pause solo dal bottone
      function setPausedUI() {
        const v = getInnerVideo();
        const paused = v ? v.paused : false;
        wrapper.classList.toggle('is-paused', !!paused);
        osdBtn?.setAttribute('aria-label', paused ? 'Play' : 'Pausa');
      }

      function togglePlayPause() {
        const v = getInnerVideo();
        if (!v) return;

        applyVideoOverlayFix(); // Riapplica fix per sicurezza

        if (v.paused) {
          setReady(false);
          v.play().catch(()=>{});
        } else {
          v.pause();
        }
        showControls();
        setPausedUI();
      }

      osdBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        togglePlayPause();
      });

      // PREWARM: appena il video è pronto/parte, scalda i layer blur una volta
      let didPrewarm = false;
      function prewarmBlurOnce() {
        if (didPrewarm) return;
        didPrewarm = true;

        wrapper.classList.add('prewarm');
        wrapper.classList.add('controls-visible');

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            wrapper.classList.remove('prewarm');
            wrapper.classList.remove('controls-visible');
          });
        });
      }

      // eventi video interno
      function hookInnerVideoEvents() {
        const v = getInnerVideo();
        if (!v) return;

        // evita doppio hook
        if (v.__hwHooked) return;
        v.__hwHooked = true;

        v.addEventListener('loadedmetadata', () => {
          applyVideoOverlayFix();
          setPausedUI();
        });

        v.addEventListener('playing', () => {
          applyVideoOverlayFix();
          setReady(true);
          setPausedUI();
          prewarmBlurOnce();
        });

        v.addEventListener('pause', () => {
          setPausedUI();
          showControls();
        });

        v.addEventListener('error', () => {
          setReady(false);
          setTimeout(() => {
            applyVideoOverlayFix();
            try {
              // se va in errore, ricarica il custom element
              hlsEl.load?.();
            } catch(e){}
            const vv = getInnerVideo();
            vv?.play?.().catch(()=>{});
          }, 1200);
        });
      }

      // prova subito e poi dopo un attimo (in alcuni casi il video nasce dopo)
      hookInnerVideoEvents();
      setTimeout(hookInnerVideoEvents, 200);
      setTimeout(hookInnerVideoEvents, 800);

      // particelle
      function createParticles() {
        const container = document.getElementById('particlesContainer');
        if (!container) return;

        const isMobile = window.innerWidth < 768;
        const snowCount = isMobile ? 35 : 70;
        const emberCount = isMobile ? 15 : 30;
        const speedModifier = isMobile ? 1.5 : 1;

        for (let i = 0; i < snowCount; i++) {
          const flake = document.createElement('div');
          flake.classList.add('snowflake');
          const size = Math.random() * 3 + 2;
          flake.style.width = size + 'px'; flake.style.height = size + 'px';
          flake.style.left = (Math.random() * 120 - 10) + 'vw';
          const duration = (Math.random() * 4 + 4) * speedModifier;
          flake.style.animation = `fall ${duration}s linear infinite`;
          flake.style.animationDelay = '-' + (Math.random() * 5) + 's';
          container.appendChild(flake);
        }

        const animations = ['riseRight', 'riseLeft', 'riseZigZag'];
        for (let i = 0; i < emberCount; i++) {
          const ember = document.createElement('div');
          ember.classList.add('ember');
          const size = Math.random() * 4 + 3;
          ember.style.width = size + 'px'; ember.style.height = size + 'px';
          ember.style.left = Math.random() * 100 + 'vw';
          const duration = (Math.random() * 6 + 6) * speedModifier;
          const randomAnim = animations[Math.floor(Math.random() * animations.length)];
          ember.style.animation = `${randomAnim} ${duration}s linear infinite`;
          ember.style.animationDelay = '-' + (Math.random() * 10) + 's';
          container.appendChild(ember);
        }
      }

      const prefersReducedMotion = !!window.matchMedia?.('(prefers-reduced-motion: reduce)').matches;
      if (!prefersReducedMotion) createParticles();

      // init UI
      setReady(false);
      setPausedUI();
      hideControls();
    })();
  </script>
</body>
</html>
