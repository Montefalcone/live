<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-TileColor" content="#000000">
  
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <title>Webcam Montefalcone di Val Fortore</title>
  <meta name="description" content="Webcam in diretta dal Comune di Montefalcone. Vista panoramica e condizioni meteo attuali">
  <meta name="keywords" content="webcam montefalcone, meteo montefalcone, comune di montefalcone live, telecamera diretta">
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="DLjKDn5UupGNdRgZXo9CuMc0Sg1S1aULxDJfIHT9tYo">
  <link rel="canonical" href="https://www.webcammontefalconedivalfortore.it/">
  
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.webcammontefalconedivalfortore.it/">
  <meta property="og:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta property="og:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta property="og:image" content="https://www.webcammontefalconedivalfortore.it/p.png">
  <meta property="og:locale" content="it_IT">
  <meta property="og:site_name" content="Webcam Montefalcone">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Webcam Montefalcone di Val Fortore - LIVE">
  <meta name="twitter:description" content="Guarda cosa succede ora a Montefalcone. Clicca per la diretta.">
  <meta name="twitter:image" content="https://www.webcammontefalconedivalfortore.it/p.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://live.webcammontefalconedivalfortore.it" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  
  <!-- Preload critico -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js" as="script">
  <link rel="preload" href="https://www.webcammontefalconedivalfortore.it/p.png" as="image">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --blur-ui: 12px;
      --blur-play: 5px;
      --color-bg: #000;
      --color-live: #ff2b2b;
      --color-live-off: #666;
      --color-white: #fff;
      --color-border: rgba(255, 255, 255, 0.18);
      --radius-pill: 999px;
      --radius-video: 15px;
      --transition-fast: 150ms ease;
      --transition-medium: 260ms ease;
      --shadow-glow: 0 0 30px rgba(255, 220, 150, 0.2);
      --shadow-deep: 0 40px 80px rgba(0, 0, 0, 0.95);
      --shadow-button: 0 10px 28px rgba(0, 0, 0, 0.28);
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      overscroll-behavior: none;
      background-color: var(--color-bg);
      -webkit-font-smoothing: antialiased;
    }

    @font-face {
      font-family: 'MerryChristmasFont';
      src: url('last.otf') format('opentype');
      font-display: swap;
    }

    #main-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 20;
    }

    @media (min-width: 1024px) {
      #main-container {
        transform: scale(0.965);
        transform-origin: center top;
      }
    }

    /* Background - SEMPLIFICATO per mobile */
    #bg-static {
      position: absolute;
      inset: 0;
      background-image: url("1a.webp");
      background-size: cover;
      background-position: center;
      z-index: 0;
      filter: brightness(0.65);
      pointer-events: none;
    }

    /* Animazione BG solo su desktop */
    @media (min-width: 769px) {
      #bg-static {
        top: -5%;
        left: -5%;
        width: 110%;
        height: 110%;
        animation: driftBg 60s ease-in-out infinite alternate;
        will-change: transform;
      }
    }

    @keyframes driftBg {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(-2%, 1%) scale(1.03); }
    }

    .municipality-logo,
    .festive-message {
      pointer-events: none;
    }

    .municipality-logo {
      width: 110px;
      height: auto;
      margin-bottom: 15px;
      z-index: 30;
      filter: brightness(1.1) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
    }

    .festive-message {
      font-family: 'MerryChristmasFont', 'Brush Script MT', cursive, serif;
      color: var(--color-white);
      text-align: center;
      font-size: 3.5rem;
      line-height: 1.2;
      margin-bottom: 25px;
      text-shadow: 2px 2px 4px var(--color-bg), 0 0 25px rgba(255, 255, 255, 0.6);
      z-index: 30;
      padding: 0 20px;
      width: 100%;
    }

    /* Vignette - SOLO CSS, niente animazioni */
    .vignette {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.7) 85%, var(--color-bg) 100%);
      z-index: 6;
      pointer-events: none;
    }

    /* Particelle - Ottimizzate per mobile */
    .particles-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      overflow: hidden;
      contain: strict; /* Isola il rendering */
    }

    .snowflake {
      position: absolute;
      top: -10px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0); /* Force GPU */
    }

    @keyframes fall {
      0% { transform: translate3d(0, -10vh, 0); }
      100% { transform: translate3d(0, 110vh, 0); }
    }

    .ember {
      position: absolute;
      bottom: -20px;
      background: #ffaa00;
      border-radius: 50%;
      opacity: 0;
      will-change: transform, opacity;
      backface-visibility: hidden;
      transform: translateZ(0);
    }

    @keyframes rise {
      0% { transform: translate3d(0, 0, 0); opacity: 0; }
      15% { opacity: 0.7; }
      100% { transform: translate3d(10vw, -100vh, 0); opacity: 0; }
    }

    /* =====================================================
       VIDEO PLAYER
       ===================================================== */
    .video-wrapper {
      position: relative;
      width: auto;
      height: 60%;
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-video);
      overflow: hidden;
      background: var(--color-bg);
      box-shadow: var(--shadow-glow), var(--shadow-deep);
      border: 1px solid var(--color-border);
      z-index: 30;
      pointer-events: auto;
    }

    .video-wrapper:fullscreen,
    .video-wrapper:-webkit-full-screen {
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
      width: 100vw !important;
      height: 100vh !important;
    }

    #liveVideo {
      width: 100%;
      height: 100%;
      display: block;
      background: var(--color-bg);
      object-fit: contain;
    }

    .tap-layer {
      position: absolute;
      inset: 0;
      z-index: 10;
      cursor: default;
    }

    /* Loading Overlay - Usa timeupdate per nascondere, non playing */
    .loading-overlay {
      position: absolute;
      inset: 0;
      z-index: 80;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--color-bg);
      pointer-events: none;
      opacity: 1;
      visibility: visible;
      transition: opacity 200ms ease, visibility 0ms linear 0ms;
    }

    .video-wrapper.is-ready .loading-overlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity 200ms ease, visibility 0ms linear 200ms;
    }

    .loading-overlay .preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.8);
      opacity: 0.85;
    }

    .loading-overlay .spinner-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .loading-overlay .spinner {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.25);
      border-top-color: rgba(255, 255, 255, 0.9);
      animation: spin 0.8s linear infinite;
    }

    .loading-overlay .status-text {
      font-family: "Poppins", sans-serif;
      font-size: 11px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Control Bar */
    .control-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.75), transparent);
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .video-wrapper.controls-visible .control-bar {
      pointer-events: auto;
      opacity: 1;
    }

    /* Fullscreen Button */
    .fs-btn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.20);
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--transition-fast);
    }

    .fs-btn:active { transform: scale(0.92); }
    .fs-btn svg { width: 20px; height: 20px; fill: var(--color-white); }
    .fs-btn .icon-exit { display: none; }
    .video-wrapper.is-fullscreen .fs-btn .icon-enter { display: none; }
    .video-wrapper.is-fullscreen .fs-btn .icon-exit { display: block; }

    /* Live Badge */
    .live-badge {
      position: absolute;
      left: 14px;
      bottom: 14px;
      z-index: 31;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-pill);
      color: var(--color-white);
      font-family: "Poppins", sans-serif;
      font-weight: 700;
      font-size: 12px;
      line-height: 1;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.18);
      border: 1px solid var(--color-border);
      backdrop-filter: blur(var(--blur-ui));
      -webkit-backdrop-filter: blur(var(--blur-ui));
      pointer-events: none;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-live);
      box-shadow: 0 0 12px rgba(255, 43, 43, 0.95);
      animation: livePulse 1.6s infinite;
    }

    .video-wrapper.is-paused .live-dot,
    .video-wrapper.is-offline .live-dot {
      background: var(--color-live-off);
      box-shadow: none;
      animation: none;
    }

    @keyframes livePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* OSD Play/Pause */
    .osd {
      position: absolute;
      inset: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .osd-chip {
      width: 84px;
      height: 84px;
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      appearance: none;
      padding: 0;
      margin: 0;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.22);
      backdrop-filter: blur(var(--blur-play));
      -webkit-backdrop-filter: blur(var(--blur-play));
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 120ms ease, transform 120ms ease;
      pointer-events: none;
    }

    .video-wrapper.controls-visible .osd-chip {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    .osd-chip:active { transform: scale(0.92); }

    .osd-icon {
      width: 40px;
      height: 40px;
      fill: var(--color-white);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .osd-icon.play { display: none; }
    .video-wrapper.is-paused .osd-icon.play { display: block; }
    .video-wrapper.is-paused .osd-icon.pause { display: none; }

    /* Curtains */
    #pageCurtain, .fs-curtain {
      background: var(--color-bg);
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease;
    }

    #pageCurtain { position: fixed; inset: 0; z-index: 9999; }
    .fs-curtain { position: absolute; inset: 0; z-index: 200; border-radius: inherit; }
    #pageCurtain.on, .fs-curtain.on { opacity: 1; }

    /* =====================================================
       RESPONSIVE
       ===================================================== */
    @media (max-width: 768px) and (orientation: portrait) {
      #main-container {
        justify-content: flex-start;
        padding-top: 18vh;
      }

      .municipality-logo {
        width: 75px;
        margin-bottom: 10px;
      }

      .festive-message {
        font-size: 6vw;
        line-height: 1.4;
        margin-bottom: 20px;
      }

      .video-wrapper {
        width: 95%;
        height: auto;
      }

      .osd-chip { width: 68px; height: 68px; }
      .osd-icon { width: 32px; height: 32px; }
      .fs-btn { width: 38px; height: 38px; }
      .live-badge { padding: 6px 10px; font-size: 10px; gap: 6px; }
      .live-dot { width: 6px; height: 6px; }
    }

    @media screen and (orientation: landscape) and (max-height: 600px) {
      .municipality-logo,
      .festive-message,
      #bg-static,
      .vignette,
      .particles-container {
        display: none !important;
      }

      #main-container {
        padding: 0 !important;
        justify-content: center !important;
        background: var(--color-bg);
      }

      .video-wrapper {
        width: 100vw;
        height: 100vh;
        border: none;
        border-radius: 0;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
      .particles-container { display: none !important; }
      .loading-overlay .spinner { animation: spin 0.8s linear infinite !important; }
    }
  </style>
</head>

<body>
  <div id="bg-static"></div>
  <div class="vignette"></div>
  <div class="particles-container" id="particlesContainer"></div>

  <div id="main-container">
    <img 
      src="stemma2-removebg-preview.png" 
      alt="Stemma Comune di Montefalcone di Val Fortore" 
      class="municipality-logo"
      width="110"
      height="110"
      loading="eager"
    >

    <div class="festive-message">
      Il comune di Montefalcone di Val Fortore<br>
      augura a tutti Buone Feste
    </div>

    <div class="video-wrapper" id="videoWrapper">
      <video
        id="liveVideo"
        playsinline
        muted
        preload="auto"
      ></video>

      <div class="loading-overlay" id="loadingOverlay">
        <img 
          class="preview" 
          src="https://www.webcammontefalconedivalfortore.it/p.png" 
          alt=""
          loading="eager"
        >
        <div class="spinner-container">
          <div class="spinner"></div>
          <div class="status-text" id="statusText">Connessione...</div>
        </div>
      </div>

      <div class="tap-layer" id="tapLayer"></div>

      <div class="live-badge">
        <span class="live-dot" id="liveDot"></span>
        <span>LIVE</span>
      </div>

      <div class="osd">
        <button class="osd-chip" id="osdBtn" type="button" aria-label="Play/Pausa">
          <svg class="osd-icon play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="osd-icon pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
      </div>

      <div class="control-bar">
        <button class="fs-btn" id="fsBtn" type="button" aria-label="Schermo intero">
          <svg class="icon-enter" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
          <svg class="icon-exit" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
        </button>
      </div>

      <div class="fs-curtain" id="fsCurtain"></div>
    </div>
  </div>

  <div id="pageCurtain"></div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>

  <script>
    (() => {
      'use strict';

      const STREAM_URL = 'https://live.webcammontefalconedivalfortore.it/memfs/58e0bcbe-f1bd-4c8b-85f7-b4566a3e5392.m3u8';

      // Config HLS ottimizzata
      const HLS_CONFIG = {
        // Live sync - HLS.js gestisce automaticamente
        liveSyncDuration: 2,
        liveMaxLatencyDuration: 6,
        liveDurationInfinity: true,
        liveBackBufferLength: 0,
        
        // Buffer ridotto per avvio veloce
        maxBufferLength: 8,
        maxMaxBufferLength: 15,
        maxBufferSize: 20 * 1000000,
        maxBufferHole: 0.3,
        
        // Startup
        startLevel: 0, // Parti dalla qualità più bassa per avvio veloce
        autoStartLoad: true,
        startPosition: -1,
        
        // Bassa latenza
        lowLatencyMode: true,
        backBufferLength: 0,
        
        // Timeout e retry
        manifestLoadingTimeOut: 6000,
        manifestLoadingMaxRetry: 3,
        levelLoadingTimeOut: 6000,
        levelLoadingMaxRetry: 3,
        fragLoadingTimeOut: 10000,
        fragLoadingMaxRetry: 4,
        
        // Performance
        enableWorker: true,
        testBandwidth: true,
      };

      const $ = id => document.getElementById(id);

      class LivePlayer {
        constructor() {
          this.wrapper = $('videoWrapper');
          this.video = $('liveVideo');
          this.tapLayer = $('tapLayer');
          this.osdBtn = $('osdBtn');
          this.fsBtn = $('fsBtn');
          this.fsCurtain = $('fsCurtain');
          this.pageCurtain = $('pageCurtain');
          this.statusText = $('statusText');

          this.hls = null;
          this.autoHideTimer = null;
          this.hasReceivedFrame = false;
          this.userPaused = false; // IMPORTANTE: traccia se l'utente ha messo in pausa

          this.init();
        }

        init() {
          this.setupPlayer();
          this.bindEvents();
          this.createParticles();
        }

        setupPlayer() {
          // Safari = HLS nativo
          if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
            this.setupNativeHLS();
          } else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
            this.setupHlsJs();
          } else {
            this.showError('Browser non supportato');
          }
        }

        setupNativeHLS() {
          this.status('Connessione...');
          this.video.src = STREAM_URL;
          this.video.load();
        }

        setupHlsJs() {
          this.status('Connessione...');

          if (this.hls) {
            this.hls.destroy();
          }

          this.hls = new Hls(HLS_CONFIG);

          this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
            this.status('Avvio...');
            this.play();
          });

          this.hls.on(Hls.Events.FRAG_BUFFERED, () => {
            // Frammento nel buffer = possiamo mostrare
            if (!this.hasReceivedFrame) {
              this.status('Buffering...');
            }
          });

          this.hls.on(Hls.Events.ERROR, (_, data) => {
            if (data.fatal) {
              console.warn('[HLS] Fatal error:', data.type, data.details);
              
              if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                this.status('Riconnessione...');
                setTimeout(() => this.hls?.startLoad(), 1500);
              } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                this.status('Recupero...');
                this.hls.recoverMediaError();
              } else {
                this.status('Errore stream');
                this.wrapper.classList.add('is-offline');
              }
            }
          });

          this.hls.loadSource(STREAM_URL);
          this.hls.attachMedia(this.video);
        }

        play() {
          this.userPaused = false;
          const p = this.video.play();
          if (p) p.catch(() => {
            this.status('Tap per avviare');
            this.showControls();
            this.setPaused(true);
          });
        }

        status(t) {
          if (this.statusText) this.statusText.textContent = t;
        }

        showError(msg) {
          this.status(msg);
          this.wrapper.classList.add('is-offline');
        }

        /* === UI === */
        setReady(ready) {
          this.wrapper.classList.toggle('is-ready', ready);
          if (ready) this.wrapper.classList.remove('is-offline');
        }

        setPaused(paused) {
          this.wrapper.classList.toggle('is-paused', paused);
        }

        showControls() {
          this.wrapper.classList.add('controls-visible');
          clearTimeout(this.autoHideTimer);
          this.autoHideTimer = setTimeout(() => {
            if (!this.video.paused) {
              this.wrapper.classList.remove('controls-visible');
            }
          }, 4000);
        }

        toggleControls() {
          if (this.wrapper.classList.contains('controls-visible')) {
            this.wrapper.classList.remove('controls-visible');
            clearTimeout(this.autoHideTimer);
          } else {
            this.showControls();
          }
        }

        togglePlayPause() {
          if (this.video.paused) {
            this.userPaused = false;
            this.setReady(false);
            this.hasReceivedFrame = false;
            this.status('Ripresa...');
            this.play();
          } else {
            this.userPaused = true; // L'utente ha VOLUTO mettere in pausa
            this.video.pause();
          }
          this.showControls();
        }

        /* === Fullscreen === */
        toggleFullscreen() {
          this.fsCurtain?.classList.add('on');
          this.pageCurtain?.classList.add('on');

          if (document.fullscreenElement || document.webkitFullscreenElement) {
            (document.exitFullscreen || document.webkitExitFullscreen).call(document);
          } else {
            (this.wrapper.requestFullscreen || this.wrapper.webkitRequestFullscreen)?.call(this.wrapper);
          }
        }

        onFullscreenChange() {
          const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement);
          this.wrapper.classList.toggle('is-fullscreen', isFs);

          if (isFs) {
            screen.orientation?.lock?.('landscape').catch(() => {});
          } else {
            screen.orientation?.unlock?.();
          }

          setTimeout(() => {
            this.fsCurtain?.classList.remove('on');
            this.pageCurtain?.classList.remove('on');
          }, 200);
        }

        /* === Events === */
        bindEvents() {
          this.tapLayer?.addEventListener('click', () => this.toggleControls());
          
          this.osdBtn?.addEventListener('click', e => {
            e.stopPropagation();
            this.togglePlayPause();
          });

          this.fsBtn?.addEventListener('click', e => {
            e.stopPropagation();
            this.toggleFullscreen();
          });

          // === VIDEO EVENTS ===
          
          // TIMEUPDATE: il modo più affidabile per sapere che ci sono frame
          this.video.addEventListener('timeupdate', () => {
            if (!this.hasReceivedFrame && this.video.currentTime > 0) {
              this.hasReceivedFrame = true;
              this.setReady(true);
              console.log('[Player] First frame received');
            }
          });

          this.video.addEventListener('playing', () => {
            this.setPaused(false);
          });

          this.video.addEventListener('pause', () => {
            this.setPaused(true);
            
            // Se l'utente NON ha messo in pausa volontariamente, riprova
            if (!this.userPaused && !document.hidden) {
              console.log('[Player] Unexpected pause, resuming...');
              setTimeout(() => {
                if (this.video.paused && !this.userPaused) {
                  this.play();
                }
              }, 500);
            } else {
              this.showControls();
            }
          });

          this.video.addEventListener('waiting', () => {
            // Il video sta bufferando, ma non nascondere se già ready
            console.log('[Player] Buffering...');
          });

          this.video.addEventListener('stalled', () => {
            console.log('[Player] Stalled');
            // Non fare nulla, HLS.js gestisce
          });

          this.video.addEventListener('error', () => {
            console.error('[Player] Video error');
            this.setReady(false);
            this.hasReceivedFrame = false;
            this.status('Riconnessione...');
            
            setTimeout(() => {
              if (this.hls) {
                this.hls.startLoad();
              } else {
                this.video.load();
              }
              this.play();
            }, 2000);
          });

          // === VISIBILITY ===
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
              // Tab tornata visibile
              if (!this.userPaused) {
                console.log('[Player] Tab visible, checking playback...');
                // Se era in pausa (browser l'ha fermato), riprendi
                if (this.video.paused) {
                  this.play();
                }
                // HLS.js gestisce il sync automaticamente
              }
            }
          });

          // Online
          window.addEventListener('online', () => {
            console.log('[Player] Online');
            if (this.hls) this.hls.startLoad();
          });

          // Fullscreen
          document.addEventListener('fullscreenchange', () => this.onFullscreenChange());
          document.addEventListener('webkitfullscreenchange', () => this.onFullscreenChange());
        }

        /* === Particelle ottimizzate === */
        createParticles() {
          if (window.matchMedia?.('(prefers-reduced-motion: reduce)').matches) return;

          const container = $('particlesContainer');
          if (!container) return;

          const isMobile = window.innerWidth < 769;
          const snowCount = isMobile ? 25 : 45;
          const emberCount = isMobile ? 10 : 20;

          const fragment = document.createDocumentFragment();
          
          // Fiocchi di neve
          for (let i = 0; i < snowCount; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            const size = Math.random() * 2.5 + 1.5;
            const duration = Math.random() * 6 + 6;
            const delay = Math.random() * -10;
            flake.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}vw;animation:fall ${duration}s linear infinite ${delay}s`;
            fragment.appendChild(flake);
          }

          // Embers (braci)
          for (let i = 0; i < emberCount; i++) {
            const ember = document.createElement('div');
            ember.className = 'ember';
            const size = Math.random() * 3 + 2;
            const duration = Math.random() * 8 + 8;
            const delay = Math.random() * -15;
            ember.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}vw;animation:rise ${duration}s linear infinite ${delay}s`;
            fragment.appendChild(ember);
          }

          container.appendChild(fragment);
        }
      }

      // Start
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => new LivePlayer());
      } else {
        new LivePlayer();
      }
    })();
  </script>
</body>
</html>
